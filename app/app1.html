<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Manager - Contas a Pagar</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-masker@1.1.1/build/vanilla-masker.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Animation for notifications */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .notification-slide-in { animation: slideIn 0.3s forwards; }
        .notification-slide-out { animation: slideOut 0.3s forwards; }
        /* Calendar day highlight */
        .calendar-day.has-bills {
            position: relative;
        }
        .calendar-day.has-bills::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen flex flex-col">
        <header class="bg-blue-600 text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-file-invoice-dollar text-2xl"></i>
                    <h1 class="text-xl font-bold">Bill Manager</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-blue-700 transition">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="relative">
                        <button id="notification-btn" class="p-2 rounded-full hover:bg-blue-700 transition relative">
                            <i class="fas fa-bell"></i>
                            <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-72 bg-white text-gray-800 rounded-md shadow-lg z-10 max-h-96 overflow-y-auto">
                            <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-semibold">Notificações</h3>
                                <button id="clear-notifications" class="text-blue-600 text-sm">Limpar tudo</button>
                            </div>
                            <div id="notification-list" class="divide-y divide-gray-200">
                                <div class="p-3 text-center text-gray-500">Nenhuma notificação</div>
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="user-menu-btn" class="flex items-center space-x-2 focus:outline-none">
                            <div class="h-8 w-8 rounded-full bg-blue-700 flex items-center justify-center text-white">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="hidden md:inline" id="user-display-name">Carregando...</span>
                        </button>
                        <div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                            <div class="py-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Perfil</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Configurações</a>
                                <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto px-4 py-6">
            <div class="flex flex-col lg:flex-row gap-6">
                <aside class="lg:w-64 bg-white rounded-lg shadow-md p-4 hidden lg:block">
                    <nav>
                        <ul class="space-y-2">
                            <li>
                                <a href="#" id="dashboard-tab" class="flex items-center space-x-3 p-3 rounded-lg bg-blue-100 text-blue-700 font-medium">
                                    <i class="fas fa-home"></i>
                                    <span>Dashboard</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="bills-tab" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-file-invoice"></i>
                                    <span>Contas</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="calendar-tab" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Calendário</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="reports-tab" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-chart-pie"></i>
                                    <span>Relatórios</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="categories-tab" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-tags"></i>
                                    <span>Categorias</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" id="settings-tab" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 text-gray-700">
                                    <i class="fas fa-cog"></i>
                                    <span>Configurações</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    <div class="mt-8">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Resumo do Mês</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">A pagar</p>
                                <p class="text-lg font-semibold text-blue-600" id="monthly-pending">R$ 0,00</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Pago</p>
                                <p class="text-lg font-semibold text-green-600" id="monthly-paid">R$ 0,00</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Atrasado</p>
                                <p class="text-lg font-semibold text-red-600" id="monthly-overdue">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                </aside>

                <div class="flex-grow bg-white rounded-lg shadow-md p-4">
                    <div class="lg:hidden mb-4">
                        <div class="flex overflow-x-auto space-x-1 pb-2">
                            <button id="mobile-dashboard-tab" class="flex-shrink-0 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium">
                                <i class="fas fa-home mr-2"></i>Dashboard
                            </button>
                            <button id="mobile-bills-tab" class="flex-shrink-0 px-4 py-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-file-invoice mr-2"></i>Contas
                            </button>
                            <button id="mobile-calendar-tab" class="flex-shrink-0 px-4 py-2 hover:bg-gray-100 rounded-lg">
                                <i class="fas fa-calendar-alt mr-2"></i>Calendário
                            </button>
                        </div>
                    </div>

                    <div id="dashboard-content">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                            <button id="add-bill-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                                <i class="fas fa-plus"></i> <span>Adicionar Conta</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-blue-600 font-medium">A pagar</p>
                                        <p class="text-2xl font-bold text-blue-800" id="pending-amount">R$ 0,00</p>
                                    </div>
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        <i class="fas fa-clock text-blue-600"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-blue-500 mt-2"><span id="pending-count">0</span> contas pendentes</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-green-600 font-medium">Pago este mês</p>
                                        <p class="text-2xl font-bold text-green-800" id="paid-amount">R$ 0,00</p>
                                    </div>
                                    <div class="p-2 bg-green-100 rounded-lg">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-green-500 mt-2"><span id="paid-count">0</span> contas pagas</p>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border border-red-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-sm text-red-600 font-medium">Atrasado</p>
                                        <p class="text-2xl font-bold text-red-800" id="overdue-amount">R$ 0,00</p>
                                    </div>
                                    <div class="p-2 bg-red-100 rounded-lg">
                                        <i class="fas fa-exclamation-circle text-red-600"></i>
                                    </div>
                                </div>
                                <p class="text-xs text-red-500 mt-2"><span id="overdue-count">0</span> contas atrasadas</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-gray-800">Próximos Vencimentos</h3>
                                <a href="#" id="view-all-bills" class="text-sm text-blue-600 hover:underline">Ver todas</a>
                            </div>
                            <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                                <div id="upcoming-bills" class="divide-y divide-gray-200">
                                    <div class="p-4 text-center text-gray-500">Nenhuma conta a vencer nos próximos dias</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Gastos por Categoria</h3>
                                <div class="h-64">
                                    <canvas id="category-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-3">Histórico Mensal</h3>
                                <div class="h-64">
                                    <canvas id="monthly-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="bills-content" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Contas a Pagar</h2>
                            <div class="flex space-x-2">
                                <button id="filter-bills-btn" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                                    <i class="fas fa-filter"></i> <span>Filtrar</span>
                                </button>
                                <button id="add-bill-btn-2" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                                    <i class="fas fa-plus"></i> <span>Adicionar</span>
                                </button>
                            </div>
                        </div>

                        <div id="filter-panel" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="status-filter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="all">Todos</option>
                                        <option value="pending">Pendente</option>
                                        <option value="paid">Pago</option>
                                        <option value="overdue">Atrasado</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                                    <select id="category-filter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="all">Todas</option>
                                        </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Período</label>
                                    <select id="period-filter" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="all">Todos</option>
                                        <option value="this-month">Este mês</option>
                                        <option value="next-month">Próximo mês</option>
                                        <option value="last-month">Mês passado</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end space-x-2">
                                <button id="reset-filters-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Limpar</button>
                                <button id="apply-filters-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Aplicar</button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimento</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoria</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="bills-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma conta cadastrada</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="calendar-content" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Calendário de Pagamentos</h2>
                            <div class="flex space-x-2">
                                <button id="prev-month-btn" class="p-2 rounded-lg hover:bg-gray-100">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="next-month-btn" class="p-2 rounded-lg hover:bg-gray-100">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <button id="today-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"> Hoje </button>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-4 border-b">
                                <h3 id="current-month-year" class="text-xl font-semibold text-gray-800">Janeiro 2023</h3>
                            </div>
                            <div class="grid grid-cols-7 gap-px bg-gray-200">
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Dom</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Seg</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Ter</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qua</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Qui</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Sex</div>
                                <div class="bg-gray-100 py-2 text-center text-xs font-medium text-gray-500 uppercase">Sáb</div>
                            </div>
                            <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200">
                                </div>
                        </div>

                        <div id="day-bills-panel" class="mt-6 hidden">
                            <div class="flex justify-between items-center mb-3">
                                <h3 id="selected-day-header" class="text-lg font-semibold text-gray-800">Contas para 1 de Janeiro</h3>
                                <button id="close-day-bills" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div id="day-bills-list" class="bg-gray-50 rounded-lg border border-gray-200 divide-y divide-gray-200">
                                <div class="p-4 text-center text-gray-500">Nenhuma conta para este dia</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="bg-white border-t border-gray-200 py-4">
            <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
                <p>Bill Manager &copy; 2023 - Sistema de Gerenciamento de Contas a Pagar</p>
            </div>
        </footer>
    </div>

    <div id="add-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Adicionar Conta</h3>
                <button id="close-add-bill-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-bill-form" class="p-6">
                <div class="mb-4">
                    <label for="bill-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                    <input type="text" id="bill-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="bill-due-date" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
                    <input type="date" id="bill-due-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="bill-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                    <input type="text" id="bill-amount" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="R$ 0,00" required>
                </div>
                <div class="mb-4">
                    <label for="bill-category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <select id="bill-category" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        <option value="">Selecione uma categoria</option>
                        </select>
                </div>
                <div class="mb-4">
                    <label for="bill-notes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="bill-notes" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-add-bill" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Editar Conta</h3>
                <button id="close-edit-bill-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-bill-form" class="p-6">
                <input type="hidden" id="edit-bill-id">
                <div class="mb-4">
                    <label for="edit-bill-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                    <input type="text" id="edit-bill-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="edit-bill-due-date" class="block text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
                    <input type="date" id="edit-bill-due-date" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="edit-bill-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor</label>
                    <input type="text" id="edit-bill-amount" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="R$ 0,00" required>
                </div>
                <div class="mb-4">
                    <label for="edit-bill-category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <select id="edit-bill-category" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        </select>
                </div>
                <div class="mb-4">
                    <label for="edit-bill-notes" class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="edit-bill-notes" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="edit-bill-paid" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50">
                        <span class="ml-2 text-sm text-gray-700">Marcar como pago</span>
                    </label>
                </div>
                <div class="flex justify-between pt-4 border-t">
                    <button type="button" id="delete-bill-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Excluir</button>
                    <div class="flex space-x-3">
                        <button type="button" id="cancel-edit-bill" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Acessar Bill Manager</h3>
            </div>
            <form id="login-form" class="p-6">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                    <input type="email" id="login-email" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4 flex items-center justify-between">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="remember-me" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50">
                        <span class="ml-2 text-sm text-gray-700">Lembrar de mim</span>
                    </label>
                    <a href="#" id="forgot-password" class="text-sm text-blue-600 hover:underline">Esqueceu a senha?</a>
                </div>
                <div class="flex flex-col space-y-3 pt-4 border-t">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Entrar</button>
                    <button type="button" id="show-register" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Criar nova conta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="register-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-800">Criar nova conta</h3>
                <button id="close-register-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="register-form" class="p-6">
                <div class="mb-4">
                    <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                    <input type="text" id="register-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                    <input type="email" id="register-email" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="register-password" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required minlength="6">
                </div>
                <div class="mb-4">
                    <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Senha</label>
                    <input type="password" id="register-confirm-password" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500" required minlength="6">
                </div>
                <div class="flex justify-between pt-4 border-t">
                    <button type="button" id="show-login" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition">Voltar para login</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Registrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-toast" class="fixed bottom-4 right-4 w-72 bg-white rounded-lg shadow-lg border border-gray-200 z-50 hidden">
        <div class="p-4">
            <div class="flex items-start">
                <div id="toast-icon" class="flex-shrink-0 pt-0.5">
                    <i class="fas fa-info-circle text-blue-500"></i>
                </div>
                <div class="ml-3 flex-1">
                    <h4 id="toast-title" class="text-sm font-medium text-gray-900">Notificação</h4>
                    <p id="toast-message" class="mt-1 text-sm text-gray-500">Mensagem de notificação</p>
                </div>
                <button id="close-toast" class="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 1. INICIALIZAÇÃO DO SUPABASE
        const SUPABASE_URL = 'https://dbzivosyeznhfdjzuhme.supabase.co'; // Substitua pela URL do seu projeto Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRieml2b3N5ZXpuaGZkanp1aG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4MjcyODEsImV4cCI6MjA2NDQwMzI4MX0.Rejo3yWsssCNgkAeZhUZXnm9a0-SQA-FaGNkjesr7Qk'; // Substitua pela sua anon public key

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // VARIÁVEIS GLOBAIS (AGORA POPULADAS PELO SUPABASE)
        let bills = [];
        let categories = ['Água', 'Luz', 'Aluguel', 'Internet', 'Telefone', 'Outros']; // Inicie com algumas para o dropdown
        let notifications = [];
        let currentUser = null; // Será preenchido pelo Supabase Auth

        let currentDate = new Date();
        let selectedDate = null;

        // ... (Seus elementos DOM existentes) ...
        const dashboardContent = document.getElementById('dashboard-content');
        const billsContent = document.getElementById('bills-content');
        const calendarContent = document.getElementById('calendar-content');

        const dashboardTab = document.getElementById('dashboard-tab');
        const billsTab = document.getElementById('bills-tab');
        const calendarTab = document.getElementById('calendar-tab');
        const reportsTab = document.getElementById('reports-tab');
        const categoriesTab = document.getElementById('categories-tab');
        const settingsTab = document.getElementById('settings-tab');

        const mobileDashboardTab = document.getElementById('mobile-dashboard-tab');
        const mobileBillsTab = document.getElementById('mobile-bills-tab');
        const mobileCalendarTab = document.getElementById('mobile-calendar-tab');

        const addBillModal = document.getElementById('add-bill-modal');
        const editBillModal = document.getElementById('edit-bill-modal');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');

        const addBillForm = document.getElementById('add-bill-form');
        const editBillForm = document.getElementById('edit-bill-form');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        const notificationBtn = document.getElementById('notification-btn');
        const notificationDropdown = document.getElementById('notification-dropdown');
        const notificationList = document.getElementById('notification-list');
        const notificationCount = document.getElementById('notification-count');
        const clearNotificationsBtn = document.getElementById('clear-notifications');
        const notificationToast = document.getElementById('notification-toast');

        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYear = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const todayBtn = document.getElementById('today-btn');
        const dayBillsPanel = document.getElementById('day-bills-panel');
        const dayBillsList = document.getElementById('day-bills-list');
        const selectedDayHeader = document.getElementById('selected-day-header');
        const closeDayBills = document.getElementById('close-day-bills');

        const categoryChartCtx = document.getElementById('category-chart').getContext('2d');
        const monthlyChartCtx = document.getElementById('monthly-chart').getContext('2d');

        let categoryChart, monthlyChart;

        // Elementos de UI específicos para autenticação
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');
        const userDisplayName = document.getElementById('user-display-name');


        // 2. INICIALIZAÇÃO DO APP E TRATAMENTO DE AUTENTICAÇÃO
        document.addEventListener('DOMContentLoaded', function() {
            // Monitorar o estado de autenticação do Supabase
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    currentUser = session.user;
                    userDisplayName.textContent = currentUser.email || 'Usuário'; // Exibe o email do usuário
                    loginModal.classList.add('hidden');
                    registerModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden'); // Habilita scroll se estava desabilitado
                    await loadData(); // Carrega os dados do usuário logado
                    showDashboard(); // Redireciona para o dashboard
                    updateCharts();
                    checkForDueBills();
                    showToast('Bem-vindo', `Olá, ${currentUser.email || 'Usuário'}!`);
                    userMenuBtn.classList.remove('hidden'); // Mostra o botão de menu do usuário
                } else {
                    currentUser = null;
                    bills = [];
                    notifications = [];
                    // Reseta UI se não houver usuário logado
                    document.getElementById('pending-amount').textContent = 'R$ 0,00';
                    document.getElementById('paid-amount').textContent = 'R$ 0,00';
                    document.getElementById('overdue-amount').textContent = 'R$ 0,00';
                    document.getElementById('pending-count').textContent = '0';
                    document.getElementById('paid-count').textContent = '0';
                    document.getElementById('overdue-count').textContent = '0';
                    document.getElementById('monthly-pending').textContent = 'R$ 0,00';
                    document.getElementById('monthly-paid').textContent = 'R$ 0,00';
                    document.getElementById('monthly-overdue').textContent = 'R$ 0,00';
                    document.getElementById('upcoming-bills').innerHTML = '<div class="p-4 text-center text-gray-500">Nenhuma conta a vencer nos próximos dias</div>';
                    document.getElementById('bills-table-body').innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma conta cadastrada</td></tr>';
                    notificationCount.classList.add('hidden');
                    notificationList.innerHTML = '<div class="p-3 text-center text-gray-500">Nenhuma notificação</div>';
                    // Esconde menus do usuário
                    userMenuBtn.classList.add('hidden');
                    userMenu.classList.add('hidden');
                    // Mostra modal de login se não estiver logado
                    loginModal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden'); // Desabilita scroll da página principal
                }
            });

            // Inicializa event listeners (mantidos na maioria)
            initEventListeners();
            initFormValidations();
            initCurrencyMask();
            populateCategoryDropdowns(); // Popula categorias ao carregar
        });

        // Event listeners (mantidos, com algumas pequenas adaptações)
        function initEventListeners() {
            dashboardTab.addEventListener('click', (e) => { e.preventDefault(); showDashboard(); });
            billsTab.addEventListener('click', (e) => { e.preventDefault(); showBills(); });
            calendarTab.addEventListener('click', (e) => { e.preventDefault(); showCalendar(); });
            reportsTab.addEventListener('click', (e) => { e.preventDefault(); showToast('Relatórios', 'Funcionalidade de relatórios será implementada em breve.'); });
            categoriesTab.addEventListener('click', async (e) => { e.preventDefault(); // Aqui você poderia abrir um modal para gerenciar categorias await renderCategoryManagement();
                showToast('Categorias', 'Gerenciamento de categorias será implementado em breve.');
            });
            settingsTab.addEventListener('click', (e) => { e.preventDefault(); showToast('Configurações', 'Configurações do usuário serão implementadas em breve.'); });

            mobileDashboardTab.addEventListener('click', (e) => { e.preventDefault(); showDashboard(); });
            mobileBillsTab.addEventListener('click', (e) => { e.preventDefault(); showBills(); });
            mobileCalendarTab.addEventListener('click', (e) => { e.preventDefault(); showCalendar(); });

            document.getElementById('add-bill-btn').addEventListener('click', () => { showAddBillModal(); });
            document.getElementById('add-bill-btn-2').addEventListener('click', () => { showAddBillModal(); });

            document.getElementById('close-add-bill-modal').addEventListener('click', () => { addBillModal.classList.add('hidden'); });
            document.getElementById('cancel-add-bill').addEventListener('click', () => { addBillModal.classList.add('hidden'); });
            document.getElementById('close-edit-bill-modal').addEventListener('click', () => { editBillModal.classList.add('hidden'); });
            document.getElementById('cancel-edit-bill').addEventListener('click', () => { editBillModal.classList.add('hidden'); });
            document.getElementById('close-day-bills').addEventListener('click', () => { dayBillsPanel.classList.add('hidden'); });

            notificationBtn.addEventListener('click', () => {
                notificationDropdown.classList.toggle('hidden');
                if (!notificationDropdown.classList.contains('hidden')) {
                    markNotificationsAsRead();
                }
            });
            clearNotificationsBtn.addEventListener('click', async () => {
                const { error } = await supabase
                    .from('notifications')
                    .delete()
                    .eq('user_id', currentUser.id); // Apenas delete as notificações do usuário logado

                if (error) {
                    showToast('Erro', 'Não foi possível limpar as notificações.');
                    console.error('Error clearing notifications:', error.message);
                } else {
                    notifications = [];
                    updateNotificationCount();
                    renderNotificationList();
                    showToast('Sucesso', 'Notificações limpas.');
                }
            });
            document.getElementById('close-toast').addEventListener('click', () => { notificationToast.classList.add('hidden'); });

            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
            todayBtn.addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });

            addBillForm.addEventListener('submit', handleAddBill);
            editBillForm.addEventListener('submit', handleEditBill);

            // Supabase Auth Event Listeners
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.classList.add('hidden');
                registerModal.classList.remove('hidden');
            });
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                registerModal.classList.add('hidden');
                loginModal.classList.remove('hidden');
            });
            document.getElementById('close-register-modal').addEventListener('click', () => {
                registerModal.classList.add('hidden');
            });
            document.getElementById('forgot-password').addEventListener('click', async (e) => {
                e.preventDefault();
                const { value: email } = await Swal.fire({
                    title: 'Redefinir Senha',
                    input: 'email',
                    inputLabel: 'Seu endereço de e-mail',
                    inputPlaceholder: 'Digite seu e-mail',
                    showCancelButton: true,
                    confirmButtonText: 'Enviar link',
                    cancelButtonText: 'Cancelar'
                });

                if (email) {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin, // Redireciona para a URL do seu app após redefinição
                    });
                    if (error) {
                        showToast('Erro', error.message);
                    } else {
                        showToast('Sucesso', 'Link de redefinição enviado para seu e-mail!');
                    }
                }
            });


            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('view-all-bills').addEventListener('click', (e) => { e.preventDefault(); showBills(); });
            document.getElementById('filter-bills-btn').addEventListener('click', () => { document.getElementById('filter-panel').classList.toggle('hidden'); });
            document.getElementById('apply-filters-btn').addEventListener('click', () => { filterBills(); document.getElementById('filter-panel').classList.add('hidden'); });
            document.getElementById('reset-filters-btn').addEventListener('click', () => {
                document.getElementById('status-filter').value = 'all';
                document.getElementById('category-filter').value = 'all';
                document.getElementById('period-filter').value = 'all';
                filterBills();
                document.getElementById('filter-panel').classList.add('hidden');
            });

            // Toggle user menu dropdown
            userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevents clicks inside from closing it immediately
                userMenu.classList.toggle('hidden');
            });
            // Close user menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!userMenu.contains(e.target) && !userMenuBtn.contains(e.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        }

        function initFormValidations() {
            registerForm.addEventListener('submit', (e) => {
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                if (password !== confirmPassword) {
                    e.preventDefault();
                    showToast('Erro', 'As senhas não coincidem.');
                }
            });
        }

        function initCurrencyMask() {
            const amountInputs = [
                document.getElementById('bill-amount'),
                document.getElementById('edit-bill-amount')
            ];
            amountInputs.forEach(input => {
                if (input) {
                    VMasker(input).maskMoney({ precision: 2, separator: ',', delimiter: '.', unit: 'R$', zeroCents: true });
                }
            });
        }

        // Função para popular os dropdowns de categoria
        async function populateCategoryDropdowns() {
            const billCategorySelect = document.getElementById('bill-category');
            const editBillCategorySelect = document.getElementById('edit-bill-category');
            const filterCategorySelect = document.getElementById('category-filter');

            // Limpa as opções existentes (exceto a primeira "Selecione uma categoria")
            billCategorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
            editBillCategorySelect.innerHTML = '';
            filterCategorySelect.innerHTML = '<option value="all">Todas</option>';

            // Carrega categorias do Supabase (se houver, senão usa as padrão)
            let fetchedCategories = [];
            if (currentUser) { // Apenas tenta buscar se houver usuário logado
                 const { data, error } = await supabase
                    .from('categories')
                    .select('name')
                    .or(`user_id.eq.${currentUser.id},user_id.is.null`) // Categorias do usuário OU categorias globais (null user_id)
                    .order('name', { ascending: true });

                if (error) {
                    console.error("Erro ao carregar categorias do Supabase:", error.message);
                } else if (data) {
                    fetchedCategories = data.map(cat => cat.name);
                }
            } else {
                 // Se não estiver logado, ainda pode mostrar as categorias padrão
                 console.log("Nenhum usuário logado. Carregando apenas categorias padrão.");
            }


            // Combine as categorias padrão com as buscadas, removendo duplicatas
            const allCategories = [...new Set([...categories, ...fetchedCategories])].sort();

            allCategories.forEach(catName => {
                const option1 = document.createElement('option');
                option1.value = catName.toLowerCase().replace(/\s/g, '-').replace(/[^\w-]/g, ''); // Limpa para ID/valor
                option1.textContent = catName;
                billCategorySelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = catName.toLowerCase().replace(/\s/g, '-').replace(/[^\w-]/g, '');
                option2.textContent = catName;
                editBillCategorySelect.appendChild(option2);

                const option3 = document.createElement('option');
                option3.value = catName.toLowerCase().replace(/\s/g, '-').replace(/[^\w-]/g, '');
                option3.textContent = catName;
                filterCategorySelect.appendChild(option3);
            });
        }


        // 3. FUNÇÕES DE AUTENTICAÇÃO COM SUPABASE
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                showToast('Erro de Login', error.message, 'error');
                console.error('Login Error:', error.message);
            } else {
                // onAuthStateChange vai lidar com a atualização da UI
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        name: name,
                    },
                },
            });

            if (error) {
                showToast('Erro de Registro', error.message, 'error');
                console.error('Registration Error:', error.message);
            } else {
                // Supabase envia um e-mail de confirmação por padrão.
                // Você pode configurar para pular a confirmação se for um app interno.
                showToast('Sucesso!', 'Verifique seu e-mail para confirmar a conta.', 'success');

                // Após o registro, insere o nome do usuário na tabela 'users'
                const { error: userInsertError } = await supabase
                    .from('users')
                    .insert([
                        { id: data.user.id, name: name, email: email }
                    ]);

                if (userInsertError) {
                    console.error("Erro ao inserir usuário na tabela 'users':", userInsertError.message);
                    showToast('Erro', 'Não foi possível salvar o perfil do usuário.', 'error');
                }

                // Redireciona para login enquanto aguarda confirmação de e-mail
                registerModal.classList.add('hidden');
                loginModal.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                showToast('Erro ao Sair', error.message, 'error');
                console.error('Logout Error:', error.message);
            } else {
                // onAuthStateChange vai lidar com a atualização da UI
            }
        }

        // 4. FUNÇÕES DE CARREGAMENTO DE DADOS COM SUPABASE
        async function loadData() {
            if (!currentUser) {
                console.warn("Nenhum usuário logado. Não é possível carregar dados.");
                return;
            }

            // Carregar Contas
            const { data: billsData, error: billsError } = await supabase
                .from('bills')
                .select('*')
                .eq('user_id', currentUser.id) // Apenas contas do usuário logado
                .order('due_date', { ascending: true });

            if (billsError) {
                showToast('Erro', 'Erro ao carregar contas: ' + billsError.message, 'error');
                console.error('Error fetching bills:', billsError.message);
                bills = [];
            } else {
                bills = billsData;
            }

            // Carregar Notificações
            const { data: notificationsData, error: notificationsError } = await supabase
                .from('notifications')
                .select('*')
                .eq('user_id', currentUser.id) // Apenas notificações do usuário logado
                .order('created_at', { ascending: false });

            if (notificationsError) {
                showToast('Erro', 'Erro ao carregar notificações: ' + notificationsError.message, 'error');
                console.error('Error fetching notifications:', notificationsError.message);
                notifications = [];
            } else {
                notifications = notificationsData;
            }

            // Carregar Categorias (personalizadas pelo usuário)
            const { data: customCategories, error: categoriesError } = await supabase
                .from('categories')
                .select('name')
                .or(`user_id.eq.${currentUser.id},user_id.is.null`) // Categorias do usuário OU categorias globais
                .order('name', { ascending: true });

            if (categoriesError) {
                console.error("Erro ao carregar categorias personalizadas:", categoriesError.message);
            } else if (customCategories.length > 0) {
                // Adiciona categorias customizadas às categorias padrão, evitando duplicatas
                const fetchedNames = customCategories.map(c => c.name);
                categories = [...new Set([...categories, ...fetchedNames])];
            }
            populateCategoryDropdowns(); // Repopula os dropdowns com as categorias atualizadas


            // Atualizar UI após carregar todos os dados
            updateDashboardSummary();
            renderUpcomingBills();
            renderBillsTable();
            renderCalendar();
            updateNotificationCount();
            renderNotificationList();
        }

        // 5. OPERAÇÕES CRUD COM SUPABASE
        async function handleAddBill(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Erro', 'Você precisa estar logado para adicionar contas.', 'error');
                return;
            }

            const name = document.getElementById('bill-name').value;
            const dueDate = document.getElementById('bill-due-date').value;
            const amount = parseFloat(document.getElementById('bill-amount').value.replace('R$', '').replace('.', '').replace(',', '.'));
            const category = document.getElementById('bill-category').value;
            const notes = document.getElementById('bill-notes').value;

            const { data, error } = await supabase
                .from('bills')
                .insert([
                    {
                        user_id: currentUser.id,
                        name,
                        due_date: dueDate,
                        amount,
                        category,
                        notes,
                        paid: false,
                    }
                ])
                .select(); // Adiciona .select() para retornar os dados inseridos

            if (error) {
                showToast('Erro', 'Não foi possível adicionar a conta: ' + error.message, 'error');
                console.error('Error adding bill:', error.message);
            } else {
                addBillModal.classList.add('hidden');
                await loadData(); // Recarrega todos os dados
                // O data[0] contém o objeto da conta recém-criada
                if (data && data.length > 0) {
                    checkBillForNotification(data[0]); // Verifica se a conta precisa de notificação
                }
                showToast('Sucesso', 'Conta adicionada com sucesso!', 'success');
            }
        }

        async function handleEditBill(e) {
            e.preventDefault();
            if (!currentUser) return;

            const billId = document.getElementById('edit-bill-id').value; // ID é UUID agora
            const name = document.getElementById('edit-bill-name').value;
            const dueDate = document.getElementById('edit-bill-due-date').value;
            const amount = parseFloat(document.getElementById('edit-bill-amount').value.replace('R$', '').replace('.', '').replace(',', '.'));
            const category = document.getElementById('edit-bill-category').value;
            const notes = document.getElementById('edit-bill-notes').value;
            const paid = document.getElementById('edit-bill-paid').checked;

            const { data, error } = await supabase
                .from('bills')
                .update({ name, due_date: dueDate, amount, category, notes, paid })
                .eq('id', billId)
                .eq('user_id', currentUser.id); // Garante que o usuário só edite suas próprias contas

            if (error) {
                showToast('Erro', 'Não foi possível atualizar a conta: ' + error.message, 'error');
                console.error('Error updating bill:', error.message);
            } else {
                editBillModal.classList.add('hidden');
                await loadData(); // Recarrega todos os dados
                showToast('Sucesso', 'Conta atualizada com sucesso!', 'success');
            }
        }

        async function handleDeleteBill(billId) {
            if (!currentUser) {
                showToast('Erro', 'Você precisa estar logado para excluir contas.', 'error');
                return;
            }

            Swal.fire({
                title: 'Tem certeza?',
                text: "Você não poderá reverter isso!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await supabase
                        .from('bills')
                        .delete()
                        .eq('id', billId)
                        .eq('user_id', currentUser.id); // Garante que o usuário só delete suas próprias contas

                    if (error) {
                        showToast('Erro', 'Não foi possível excluir a conta: ' + error.message, 'error');
                        console.error('Error deleting bill:', error.message);
                    } else {
                        await loadData(); // Recarrega todos os dados
                        Swal.fire(
                            'Excluído!',
                            'A conta foi excluída.',
                            'success'
                        );
                    }
                }
            });
        }

        // Função para adicionar uma notificação ao banco de dados
        async function addNotificationToDB(title, message) {
            if (!currentUser) return;
            const { data, error } = await supabase
                .from('notifications')
                .insert([{ user_id: currentUser.id, title, message, read: false }])
                .select(); // Retorna o objeto da notificação inserida

            if (error) {
                console.error('Error adding notification to DB:', error.message);
            } else if (data && data.length > 0) {
                notifications.unshift(data[0]); // Adiciona ao início da lista local
                updateNotificationCount();
                renderNotificationList();
            }
        }

        async function markNotificationsAsRead() {
            if (!currentUser) return;
            // Marca todas as notificações não lidas do usuário como lidas
            const { error } = await supabase
                .from('notifications')
                .update({ read: true })
                .eq('user_id', currentUser.id)
                .eq('read', false); // Apenas as não lidas

            if (error) {
                console.error('Error marking notifications as read:', error.message);
            } else {
                notifications.forEach(n => n.read = true);
                updateNotificationCount();
                renderNotificationList();
            }
        }

        // Funções de Renderização e Lógica (mantidas, com adaptações para dados carregados)
        function updateDashboardSummary() {
            const now = new Date();
            const today = formatDateForInput(now);

            const pendingBills = bills.filter(bill => !bill.paid && bill.due_date >= today);
            const paidBills = bills.filter(bill => bill.paid); // Você pode querer filtrar por mês/período para "Pago este mês"
            const overdueBills = bills.filter(bill => !bill.paid && bill.due_date < today);

            const pendingTotal = pendingBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);
            const paidTotal = paidBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);
            const overdueTotal = overdueBills.reduce((sum, bill) => sum + parseFloat(bill.amount), 0);

            document.getElementById('pending-amount').textContent = formatCurrency(pendingTotal);
            document.getElementById('pending-count').textContent = pendingBills.length;
            document.getElementById('paid-amount').textContent = formatCurrency(paidTotal);
            document.getElementById('paid-count').textContent = paidBills.length;
            document.getElementById('overdue-amount').textContent = formatCurrency(overdueTotal);
            document.getElementById('overdue-count').textContent = overdueBills.length;

            document.getElementById('monthly-pending').textContent = formatCurrency(pendingTotal);
            document.getElementById('monthly-paid').textContent = formatCurrency(paidTotal);
            document.getElementById('monthly-overdue').textContent = formatCurrency(overdueTotal);
            updateCharts(); // Atualiza os gráficos sempre que o resumo é atualizado
        }

        function renderUpcomingBills() {
            const now = new Date();
            const today = formatDateForInput(now);
            const nextWeek = new Date(now);
            nextWeek.setDate(now.getDate() + 7);
            const nextWeekStr = formatDateForInput(nextWeek);

            const upcomingBills = bills.filter(bill => !bill.paid && bill.due_date >= today && bill.due_date <= nextWeekStr)
                                       .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));

            const upcomingBillsContainer = document.getElementById('upcoming-bills');
            upcomingBillsContainer.innerHTML = '';

            if (upcomingBills.length === 0) {
                upcomingBillsContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Nenhuma conta a vencer nos próximos dias</div>';
                return;
            }

            upcomingBills.forEach(bill => {
                const billElement = document.createElement('div');
                billElement.className = 'p-4 hover:bg-gray-100 transition cursor-pointer';
                billElement.addEventListener('click', () => showEditBillModal(bill.id));

                const isToday = bill.due_date === today;
                const dueDate = new Date(bill.due_date + 'T00:00:00'); // Garante que a data seja interpretada como local
                const dueDateStr = isToday ? 'Hoje' : formatDate(dueDate);

                billElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-800">${bill.name}</h4>
                            <p class="text-sm text-gray-500">${getCategoryName(bill.category)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold ${isToday ? 'text-red-600' : 'text-gray-800'}">${formatCurrency(parseFloat(bill.amount))}</p>
                            <p class="text-sm ${isToday ? 'text-red-500' : 'text-gray-500'}">${dueDateStr}</p>
                        </div>
                    </div>
                `;
                upcomingBillsContainer.appendChild(billElement);
            });
        }

        function renderBillsTable() {
            const tableBody = document.getElementById('bills-table-body');
            tableBody.innerHTML = '';

            if (bills.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma conta cadastrada</td>
                    </tr>
                `;
                return;
            }

            const sortedBills = [...bills].sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            sortedBills.forEach(bill => {
                const dueDate = new Date(bill.due_date + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let statusClass = '';
                let statusText = '';
                if (bill.paid) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Pago';
                } else if (dueDate < today) {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Atrasado';
                } else {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'Pendente';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${bill.name}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(dueDate)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(bill.amount))}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${getCategoryName(bill.category)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 edit-bill-btn" data-id="${bill.id}">Editar</button>
                        <button class="text-red-600 hover:text-red-900 delete-bill-btn" data-id="${bill.id}">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const billId = e.target.getAttribute('data-id'); // UUID agora
                    showEditBillModal(billId);
                });
            });
            document.querySelectorAll('.delete-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const billId = e.target.getAttribute('data-id'); // UUID agora
                    handleDeleteBill(billId);
                });
            });
        }

        function filterBills() {
            const statusFilter = document.getElementById('status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const periodFilter = document.getElementById('period-filter').value;
            const now = new Date();
            const todayStr = formatDateForInput(now);

            const filteredBills = bills.filter(bill => {
                // Status filter
                if (statusFilter === 'pending') {
                    if (bill.paid || new Date(bill.due_date + 'T00:00:00') < new Date(todayStr + 'T00:00:00')) return false;
                }
                if (statusFilter === 'paid' && !bill.paid) return false;
                if (statusFilter === 'overdue' && (bill.paid || new Date(bill.due_date + 'T00:00:00') >= new Date(todayStr + 'T00:00:00'))) return false;

                // Category filter
                if (categoryFilter !== 'all' && bill.category !== categoryFilter) return false;

                // Period filter
                if (periodFilter !== 'all') {
                    const billDate = new Date(bill.due_date + 'T00:00:00');
                    const billMonth = billDate.getMonth();
                    const billYear = billDate.getFullYear();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                    if (periodFilter === 'this-month' && (billMonth !== currentMonth || billYear !== currentYear)) return false;
                    if (periodFilter === 'next-month') {
                        let nextMonth = currentMonth + 1;
                        let nextYear = currentYear;
                        if (nextMonth > 11) { nextMonth = 0; nextYear++; }
                        if (billMonth !== nextMonth || billYear !== nextYear) return false;
                    }
                    if (periodFilter === 'last-month') {
                        let lastMonth = currentMonth - 1;
                        let lastYear = currentYear;
                        if (lastMonth < 0) { lastMonth = 11; lastYear--; }
                        if (billMonth !== lastMonth || billYear !== lastYear) return false;
                    }
                }
                return true;
            });
            renderFilteredBillsTable(filteredBills);
        }

        function renderFilteredBillsTable(filteredBills) {
            const tableBody = document.getElementById('bills-table-body');
            tableBody.innerHTML = '';
            if (filteredBills.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">Nenhuma conta encontrada</td>
                    </tr>
                `;
                return;
            }
            filteredBills.forEach(bill => {
                const dueDate = new Date(bill.due_date + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let statusClass = '';
                let statusText = '';
                if (bill.paid) {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = 'Pago';
                } else if (dueDate < today) {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = 'Atrasado';
                } else {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = 'Pendente';
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${bill.name}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatDate(dueDate)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 font-medium">${formatCurrency(parseFloat(bill.amount))}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${getCategoryName(bill.category)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-900 mr-3 edit-bill-btn" data-id="${bill.id}">Editar</button>
                        <button class="text-red-600 hover:text-red-900 delete-bill-btn" data-id="${bill.id}">Excluir</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('.edit-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const billId = e.target.getAttribute('data-id');
                    showEditBillModal(billId);
                });
            });
            document.querySelectorAll('.delete-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const billId = e.target.getAttribute('data-id');
                    handleDeleteBill(billId);
                });
            });
        }


        function renderCalendar() {
            calendarGrid.innerHTML = '';
            dayBillsPanel.classList.add('hidden'); // Esconde o painel de contas do dia ao mudar o mês

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            currentMonthYear.textContent = new Date(year, month).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();

            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 = Domingo, 1 = Segunda...

            // Preenche dias vazios antes do primeiro dia do mês
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day bg-gray-50 h-24 border border-gray-200 flex items-center justify-center text-gray-400';
                calendarGrid.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDate = new Date(year, month, day);
                const dayDateStr = formatDateForInput(dayDate);
                const billsOnThisDay = bills.filter(bill => bill.due_date === dayDateStr && !bill.paid);

                const dayElement = document.createElement('div');
                dayElement.className = `calendar-day h-24 border border-gray-200 p-2 flex flex-col cursor-pointer hover:bg-gray-100 transition relative`;
                if (dayDate.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('bg-blue-100', 'text-blue-800', 'font-bold');
                } else {
                    dayElement.classList.add('bg-white', 'text-gray-800');
                }

                if (billsOnThisDay.length > 0) {
                    dayElement.classList.add('has-bills');
                }

                dayElement.innerHTML = `
                    <span class="text-sm">${day}</span>
                    <div class="flex-grow text-xs overflow-y-auto mt-1">
                        ${billsOnThisDay.map(bill => `<p class="truncate text-red-600">${formatCurrency(parseFloat(bill.amount))}</p>`).join('')}
                    </div>
                `;
                dayElement.addEventListener('click', () => showDayBills(dayDate));
                calendarGrid.appendChild(dayElement);
            }
        }

        function showDayBills(date) {
            selectedDate = date;
            const dateStr = formatDateForInput(date);
            const billsForDay = bills.filter(bill => bill.due_date === dateStr);

            selectedDayHeader.textContent = `Contas para ${formatDate(date)}`;
            dayBillsList.innerHTML = '';

            if (billsForDay.length === 0) {
                dayBillsList.innerHTML = '<div class="p-4 text-center text-gray-500">Nenhuma conta para este dia</div>';
            } else {
                billsForDay.forEach(bill => {
                    const billElement = document.createElement('div');
                    billElement.className = 'p-4 hover:bg-gray-100 transition cursor-pointer flex justify-between items-center';
                    billElement.addEventListener('click', () => showEditBillModal(bill.id));

                    let statusClass = '';
                    let statusText = '';
                    if (bill.paid) {
                        statusClass = 'bg-green-100 text-green-800';
                        statusText = 'Pago';
                    } else if (new Date(bill.due_date + 'T00:00:00') < new Date(formatDateForInput(new Date()) + 'T00:00:00')) {
                        statusClass = 'bg-red-100 text-red-800';
                        statusText = 'Atrasado';
                    } else {
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusText = 'Pendente';
                    }

                    billElement.innerHTML = `
                        <div>
                            <h4 class="font-medium text-gray-800">${bill.name}</h4>
                            <p class="text-sm text-gray-500">${getCategoryName(bill.category)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold">${formatCurrency(parseFloat(bill.amount))}</p>
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </div>
                    `;
                    dayBillsList.appendChild(billElement);
                });
            }
            dayBillsPanel.classList.remove('hidden');
        }


        function updateCharts() {
            // Destrói gráficos existentes antes de criar novos
            if (categoryChart) categoryChart.destroy();
            if (monthlyChart) monthlyChart.destroy();

            // Gastos por Categoria
            const categoryData = {};
            bills.forEach(bill => {
                if (!bill.paid) { // Apenas contas a pagar para este gráfico
                    const catName = getCategoryName(bill.category);
                    categoryData[catName] = (categoryData[catName] || 0) + parseFloat(bill.amount);
                }
            });

            categoryChart = new Chart(categoryChartCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#6366f1', '#a855f7', '#ec4899', '#facc15'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });

            // Histórico Mensal
            const monthlyData = {};
            const today = new Date();
            for (let i = 0; i < 6; i++) { // Últimos 6 meses
                const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = month.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                monthlyData[monthKey] = { paid: 0, pending: 0 };
            }

            bills.forEach(bill => {
                const billDate = new Date(bill.due_date + 'T00:00:00');
                const billMonthKey = billDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });

                if (monthlyData[billMonthKey]) {
                    if (bill.paid) {
                        monthlyData[billMonthKey].paid += parseFloat(bill.amount);
                    } else {
                        monthlyData[billMonthKey].pending += parseFloat(bill.amount);
                    }
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/');
                const [monthB, yearB] = b.split('/');
                // Ajuste para lidar com anos formatados como "24" para 2024
                const fullYearA = parseInt(`20${yearA}`);
                const fullYearB = parseInt(`20${yearB}`);
                
                const dateA = new Date(fullYearA, new Date(`${monthA} 1, 2000`).getMonth(), 1); // Cria data para comparação
                const dateB = new Date(fullYearB, new Date(`${monthB} 1, 2000`).getMonth(), 1);
                return dateA - dateB;
            });

            monthlyChart = new Chart(monthlyChartCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'Pago',
                            data: sortedMonths.map(month => monthlyData[month].paid),
                            backgroundColor: '#22c55e',
                        },
                        {
                            label: 'A Pagar',
                            data: sortedMonths.map(month => monthlyData[month].pending),
                            backgroundColor: '#3b82f6',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });
        }


        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                notificationCount.textContent = unreadCount;
                notificationCount.classList.remove('hidden');
            } else {
                notificationCount.classList.add('hidden');
            }
        }

        function renderNotificationList() {
            notificationList.innerHTML = '';
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="p-3 text-center text-gray-500">Nenhuma notificação</div>';
                return;
            }

            notifications.forEach(n => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `p-3 flex items-start space-x-3 ${n.read ? 'text-gray-500' : 'font-medium text-gray-800'}`;
                notificationItem.innerHTML = `
                    <i class="fas fa-bell text-blue-500 mt-1"></i>
                    <div class="flex-grow">
                        <p class="text-sm">${n.title}</p>
                        <p class="text-xs text-gray-500">${n.message}</p>
                        <p class="text-xs text-gray-400 mt-1">${timeAgo(new Date(n.created_at))}</p>
                    </div>
                `;
                notificationList.appendChild(notificationItem);
            });
        }

        async function checkForDueBills() {
            if (!currentUser) return;
            const now = new Date();
            const today = formatDateForInput(now);
            const tomorrow = formatDateForInput(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1));

            // Notificações para contas vencendo hoje
            const dueToday = bills.filter(bill => bill.due_date === today && !bill.paid);
            for (const bill of dueToday) {
                // Evitar duplicidade de notificação (opcional, pode ser mais sofisticado)
                const alreadyNotified = notifications.some(n =>
                    n.message.includes(bill.name) &&
                    new Date(n.created_at).toDateString() === now.toDateString() &&
                    n.title.includes('Hoje')
                );
                if (!alreadyNotified) {
                    await addNotificationToDB('Conta Vencendo Hoje!', `A conta '${bill.name}' de ${formatCurrency(parseFloat(bill.amount))} vence hoje.`);
                    showToast('Vencimento!', `A conta '${bill.name}' vence hoje.`, 'warning');
                }
            }

            // Notificações para contas vencendo amanhã
            const dueTomorrow = bills.filter(bill => bill.due_date === tomorrow && !bill.paid);
            for (const bill of dueTomorrow) {
                const alreadyNotified = notifications.some(n =>
                    n.message.includes(bill.name) &&
                    new Date(n.created_at).toDateString() === now.toDateString() &&
                    n.title.includes('Próximo Vencimento')
                );
                if (!alreadyNotified) {
                    await addNotificationToDB('Próximo Vencimento', `A conta '${bill.name}' de ${formatCurrency(parseFloat(bill.amount))} vence amanhã.`);
                    showToast('Vencimento Próximo', `A conta '${bill.name}' vence amanhã.`, 'info');
                }
            }

            // Você pode adicionar lógica para atrasados aqui também
        }

        async function checkBillForNotification(bill) {
            if (!currentUser || bill.paid) return; // Não notifica se a conta já estiver paga

            const now = new Date();
            const todayStr = formatDateForInput(now);
            const tomorrowStr = formatDateForInput(new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1));
            const billDueDate = bill.due_date;

            // Verifica se a notificação já existe para hoje/amanhã para esta conta específica
            const alreadyNotifiedToday = notifications.some(n =>
                n.message.includes(bill.name) &&
                new Date(n.created_at).toDateString() === now.toDateString() &&
                n.title.includes('Hoje')
            );
            const alreadyNotifiedTomorrow = notifications.some(n =>
                n.message.includes(bill.name) &&
                new Date(n.created_at).toDateString() === now.toDateString() &&
                n.title.includes('Próximo Vencimento')
            );

            if (billDueDate === todayStr && !alreadyNotifiedToday) {
                await addNotificationToDB('Conta Vencendo Hoje!', `A conta '${bill.name}' de ${formatCurrency(parseFloat(bill.amount))} vence hoje.`);
                showToast('Vencimento!', `A conta '${bill.name}' vence hoje.`, 'warning');
            } else if (billDueDate === tomorrowStr && !alreadyNotifiedTomorrow) {
                await addNotificationToDB('Próximo Vencimento', `A conta '${bill.name}' de ${formatCurrency(parseFloat(bill.amount))} vence amanhã.`);
                showToast('Vencimento Próximo', `A conta '${bill.name}' vence amanhã.`, 'info');
            }
        }


        // Funções Utilitárias
        function formatCurrency(amount) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
        }

        function formatDate(date) {
            if (!(date instanceof Date)) { // Garante que é um objeto Date
                date = new Date(date);
            }
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function getCategoryName(key) {
            // Adaptação para categorias
            const found = categories.find(cat => cat.toLowerCase().replace(/\s/g, '-').replace(/[^\w-]/g, '') === key);
            return found || key; // Retorna o nome formatado ou a chave original se não encontrar
        }

        function showToast(title, message, type = 'info') {
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            const toastIcon = document.getElementById('toast-icon');
            toastIcon.innerHTML = ''; // Limpa ícones anteriores
            let iconClass = 'fas fa-info-circle text-blue-500'; // Padrão
            if (type === 'success') {
                iconClass = 'fas fa-check-circle text-green-500';
            } else if (type === 'error') {
                iconClass = 'fas fa-times-circle text-red-500';
            } else if (type === 'warning') {
                iconClass = 'fas fa-exclamation-triangle text-yellow-500';
            }
            const iconElement = document.createElement('i');
            iconElement.className = iconClass;
            toastIcon.appendChild(iconElement);

            notificationToast.classList.remove('hidden');
            notificationToast.classList.add('notification-slide-in');

            setTimeout(() => {
                notificationToast.classList.remove('notification-slide-in');
                notificationToast.classList.add('notification-slide-out');
                setTimeout(() => {
                    notificationToast.classList.add('hidden');
                    notificationToast.classList.remove('notification-slide-out');
                }, 300); // Duração da animação slideOut
            }, 5000);
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atrás";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutos atrás";
            return Math.floor(seconds) + " segundos atrás";
        }

        function toggleTheme() {
            // Implementação de tema escuro/claro
            const body = document.body;
            const isDarkMode = body.classList.toggle('dark'); // Alterna a classe 'dark'

            // Ajusta o background e o texto principal do body
            body.classList.toggle('bg-gray-50', !isDarkMode);
            body.classList.toggle('text-gray-900', !isDarkMode);
            body.classList.toggle('bg-gray-800', isDarkMode);
            body.classList.toggle('text-white', isDarkMode);

            // Seleciona todos os elementos que precisam ter o tema ajustado
            const elementsToAdjust = document.querySelectorAll('.bg-white, .bg-gray-50, .border-gray-100, .border-gray-200, .text-gray-800, .text-gray-700, .text-gray-500, .text-gray-900, .border-gray-300');

            elementsToAdjust.forEach(el => {
                if (el.classList.contains('bg-white')) {
                    el.classList.toggle('bg-white', !isDarkMode);
                    el.classList.toggle('bg-gray-700', isDarkMode);
                }
                if (el.classList.contains('bg-gray-50')) {
                    el.classList.toggle('bg-gray-50', !isDarkMode);
                    el.classList.toggle('bg-gray-600', isDarkMode);
                }
                if (el.classList.contains('border-gray-100')) {
                    el.classList.toggle('border-gray-100', !isDarkMode);
                    el.classList.toggle('border-gray-600', isDarkMode);
                }
                if (el.classList.contains('border-gray-200')) {
                    el.classList.toggle('border-gray-200', !isDarkMode);
                    el.classList.toggle('border-gray-500', isDarkMode);
                }
                if (el.classList.contains('border-gray-300')) {
                    el.classList.toggle('border-gray-300', !isDarkMode);
                    el.classList.toggle('border-gray-400', isDarkMode);
                }
                if (el.classList.contains('text-gray-800')) {
                    el.classList.toggle('text-gray-800', !isDarkMode);
                    el.classList.toggle('text-gray-100', isDarkMode);
                }
                if (el.classList.contains('text-gray-700')) {
                    el.classList.toggle('text-gray-700', !isDarkMode);
                    el.classList.toggle('text-gray-200', isDarkMode);
                }
                if (el.classList.contains('text-gray-500')) {
                    el.classList.toggle('text-gray-500', !isDarkMode);
                    el.classList.toggle('text-gray-300', isDarkMode);
                }
                if (el.classList.contains('text-gray-900')) {
                    el.classList.toggle('text-gray-900', !isDarkMode);
                    el.classList.toggle('text-white', isDarkMode);
                }
            });

            // Ajustes específicos para elementos no cabeçalho e sidebar
            document.querySelector('header').classList.toggle('bg-blue-600', !isDarkMode);
            document.querySelector('header').classList.toggle('bg-blue-800', isDarkMode);
            document.querySelector('aside').classList.toggle('bg-white', !isDarkMode);
            document.querySelector('aside').classList.toggle('bg-gray-700', isDarkMode);

            // Ajustar cores dos links de navegação na sidebar
            document.querySelectorAll('aside nav ul li a').forEach(link => {
                link.classList.toggle('text-gray-700', !isDarkMode);
                link.classList.toggle('hover:bg-gray-100', !isDarkMode);
                link.classList.toggle('text-gray-200', isDarkMode);
                link.classList.toggle('hover:bg-gray-600', isDarkMode);
            });

            // Ajustar o estado ativo da aba Dashboard
            const dashboardLink = document.getElementById('dashboard-tab');
            if (dashboardLink.classList.contains('bg-blue-100')) { // Se estiver ativo
                dashboardLink.classList.toggle('bg-blue-100', !isDarkMode);
                dashboardLink.classList.toggle('text-blue-700', !isDarkMode);
                dashboardLink.classList.toggle('bg-blue-700', isDarkMode); // Nova cor de fundo para dark mode
                dashboardLink.classList.toggle('text-white', isDarkMode); // Nova cor de texto para dark mode
            }


            showToast('Tema', `Tema ${isDarkMode ? 'escuro' : 'claro'} ativado!`);
        }
    </script>
</body>
</html>
