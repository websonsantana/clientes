<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="description" content="Sistema de Gestão de Produção - Vila Frios">
    <title>Vila Frios - Gestão de Produção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --primary-light: #3b82f6;
            --secondary-color: #047857;
            --accent-color: #d97706;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #374151;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        h1, h2, h3, h4 {
            font-weight: 600;
            color: #111827;
        }
        
        .sidebar {
            transition: all 0.3s ease;
            background-color: var(--primary-color);
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .logo-text {
            display: none;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
        }
        
        .content {
            transition: all 0.3s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .data-table tr:hover {
            background-color: #f3f4f6;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s forwards;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: slideIn 0.3s forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .hidden-content {
            display: none;
        }
        
        .nav-item.active {
            background-color: #1d4ed8;
        }
        
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .form-control {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .action-btn {
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 100;
                height: 100vh;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
                width: 100%;
            }
            
            header {
                padding: 0.75rem;
            }
            
            .search-input, .header-icons {
                display: none;
            }
            
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .overflow-x-auto {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            button, .btn {
                padding: 0.75rem 1rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            .modal-content {
                width: 95%;
                margin: 1rem auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            html {
                font-size: 14px;
            }
            
            input, select, textarea {
                font-size: 16px;
            }
        }
        
        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 90;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 99;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <div class="sidebar w-64 flex flex-col">
            <div class="p-4 flex items-center border-b border-blue-700">
                <i class="fas fa-utensils text-2xl mr-3 text-white"></i>
                <span class="logo-text text-xl font-bold text-white">Vila Frios</span>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div class="p-4">
                    <div class="mb-6">
                        <div class="text-xs uppercase text-blue-200 mb-2">Menu Principal</div>
                        <ul>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 active text-white" data-content="dashboard-content">
                                    <i class="fas fa-tachometer-alt mr-3"></i>
                                    <span class="nav-text">Dashboard</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="products-content">
                                    <i class="fas fa-box-open mr-3"></i>
                                    <span class="nav-text">Produtos</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="suppliers-content">
                                    <i class="fas fa-truck mr-3"></i>
                                    <span class="nav-text">Fornecedores</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="employees-content">
                                    <i class="fas fa-users mr-3"></i>
                                    <span class="nav-text">Colaboradores</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="production-content">
                                    <i class="fas fa-industry mr-3"></i>
                                    <span class="nav-text">Produção</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="reports-content">
                                    <i class="fas fa-chart-bar mr-3"></i>
                                    <span class="nav-text">Relatórios</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="mb-6">
                        <div class="text-xs uppercase text-blue-200 mb-2">Configurações</div>
                        <ul>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="goals-content">
                                    <i class="fas fa-bullseye mr-3"></i>
                                    <span class="nav-text">Metas</span>
                                </a>
                            </li>
                            <li class="mb-1">
                                <a href="#" class="nav-item flex items-center p-2 rounded hover:bg-blue-700 text-white" data-content="users-content">
                                    <i class="fas fa-user-shield mr-3"></i>
                                    <span class="nav-text">Usuários</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-blue-700">
                <div class="flex items-center">
                    <img src="https://via.placeholder.com/40" alt="User" class="rounded-full mr-2">
                    <div>
                        <div class="text-sm font-medium text-white">Admin User</div>
                        <div class="text-xs text-blue-200">Administrador</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content flex-1 overflow-auto">
            <header class="bg-white shadow-sm">
                <div class="flex justify-between items-center p-4">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="mr-4 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="text-xl font-semibold text-gray-800" id="page-title">Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative search-input">
                            <input type="text" placeholder="Pesquisar..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <button class="p-2 text-gray-500 hover:text-gray-700 header-icons">
                            <i class="fas fa-bell"></i>
                        </button>
                        <button class="p-2 text-gray-500 hover:text-gray-700 header-icons">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="p-6">
                <div id="dashboard-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Produção Hoje</p>
                                    <h3 class="text-2xl font-semibold" id="daily-production">1,248 kg</h3>
                                </div>
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-industry"></i>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-sm">
                                <span class="text-green-500 font-medium flex items-center">
                                    <i class="fas fa-caret-up mr-1"></i> 12%
                                </span>
                                <span class="text-gray-500 ml-2">vs ontem</span>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Perdas Hoje</p>
                                    <h3 class="text-2xl font-semibold" id="daily-losses">48 kg</h3>
                                </div>
                                <div class="p-3 rounded-full bg-red-100 text-red-600">
                                    <i class="fas fa-percentage"></i>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-sm">
                                <span class="text-red-500 font-medium flex items-center">
                                    <i class="fas fa-caret-down mr-1"></i> 5%
                                </span>
                                <span class="text-gray-500 ml-2">vs ontem</span>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Rentabilidade Média</p>
                                    <h3 class="text-2xl font-semibold" id="avg-profitability">72%</h3>
                                </div>
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-sm">
                                <span class="text-green-500 font-medium flex items-center">
                                    <i class="fas fa-caret-up mr-1"></i> 3%
                                </span>
                                <span class="text-gray-500 ml-2">vs ontem</span>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Meta Mensal</p>
                                    <h3 class="text-2xl font-semibold" id="monthly-goal-progress">78%</h3>
                                </div>
                                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                    <i class="fas fa-bullseye"></i>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-yellow-500 h-2.5 rounded-full" style="width: 78%" id="monthly-goal-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="card p-6 lg:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold">Desempenho de Produção (7 dias)</h2>
                                <select class="border rounded px-3 py-1 text-sm form-control">
                                    <option>Últimos 7 dias</option>
                                    <option>Últimos 30 dias</option>
                                    <option>Este mês</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="productionChart"></canvas>
                            </div>
                        </div>
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold">Top Produtos</h2>
                                <button class="text-blue-600 text-sm font-medium">Ver todos</button>
                            </div>
                            <div class="space-y-4" id="top-products-list">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-hamburger text-blue-600"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="font-medium">Hambúrguer Artesanal</p>
                                        <p class="text-sm text-gray-500">R$ 12,80/kg</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium">1,024 kg</p>
                                        <p class="text-sm text-green-500">+12%</p>
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-drumstick-bite text-green-600"></i>
                                    </div>
                                    <div class="flex-grow">
                                        <p class="font-medium">Peito de Frango</p>
                                        <p class="text-sm text-gray-500">R$ 8,50/kg</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium">856 kg</p>
                                        <p class="text-sm text-green-500">+8%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold">Últimas Produções</h2>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 btn btn-primary" id="new-production-btn">Nova Produção</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Produto</th>
                                        <th>Peso Bruto</th>
                                        <th>Peso Líquido</th>
                                        <th>Retraço</th>
                                        <th>Perdas (%)</th>
                                        <th>Rentabilidade (%)</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="production-table-body">
                                    <tr>
                                        <td>15/06/2023</td>
                                        <td>Hambúrguer Artesanal</td>
                                        <td>150 kg</td>
                                        <td>142 kg</td>
                                        <td>5 kg</td>
                                        <td>2%</td>
                                        <td>75%</td>
                                        <td>
                                            <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn"><i class="fas fa-edit"></i></button>
                                            <button class="text-red-600 hover:text-red-800 action-btn"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>15/06/2023</td>
                                        <td>Peito de Frango</td>
                                        <td>200 kg</td>
                                        <td>192 kg</td>
                                        <td>6 kg</td>
                                        <td>1%</td>
                                        <td>82%</td>
                                        <td>
                                            <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn"><i class="fas fa-edit"></i></button>
                                            <button class="text-red-600 hover:text-red-800 action-btn"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Outras seções de conteúdo (products-content, suppliers-content, etc.) -->
                <!-- Mantenha o restante do seu HTML existente aqui -->
                <!-- ... -->

            </main>
        </div>
    </div>

    <!-- Botão de menu mobile -->
    <button class="mobile-menu-btn" id="mobile-menu-toggle">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Overlay para menu mobile -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Modais (mantenha seus modais existentes) -->
    <!-- ... -->

    <script>
        const sidebar = document.querySelector('.sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const content = document.querySelector('.content');
        const pageTitle = document.getElementById('page-title');
        const navItems = document.querySelectorAll('.nav-item');
        const mainContent = document.querySelector('main');

        // Modals
        const newProductionModal = document.getElementById('newProductionModal');
        const closeProductionModal = document.getElementById('closeProductionModal');
        const newProductionBtn = document.getElementById('new-production-btn');
        const addProductionRecordBtn = document.getElementById('add-production-record-btn');
        const productionForm = document.getElementById('production-form');
        const productionTableBody = document.getElementById('production-table-body');
        const detailedProductionTableBody = document.getElementById('detailed-production-table-body');
        const addRawMaterialBtn = document.getElementById('add-raw-material-btn');
        const rawMaterialsList = document.getElementById('raw-materials-list');

        const genericModal = document.getElementById('genericModal');
        const closeGenericModal = document.getElementById('closeGenericModal');
        const genericModalTitle = document.getElementById('generic-modal-title');
        const genericForm = document.getElementById('generic-form');

        // Placeholder Data (replace with actual backend data)
        let productionData = [
            { id: 'prod001', date: '2023-07-27', product: 'Hambúrguer Artesanal', lot: 'L001', employee: 'Maria Souza', gross: 150, net: 142, shrinkage: 5, rawMaterialCost: 850 },
            { id: 'prod002', date: '2023-07-27', product: 'Peito de Frango', lot: 'L002', employee: 'Carlos Almeida', gross: 200, net: 192, shrinkage: 6, rawMaterialCost: 1200 },
            { id: 'prod003', date: '2023-07-26', product: 'Hambúrguer Artesanal', lot: 'L003', employee: 'Maria Souza', gross: 140, net: 135, shrinkage: 3, rawMaterialCost: 800 },
            { id: 'prod004', date: '2023-07-26', product: 'Queijo Minas', lot: 'L004', employee: 'Carlos Almeida', gross: 100, net: 95, shrinkage: 2, rawMaterialCost: 600 }
        ];

        let productsData = [
            { id: 'P001', name: 'Hambúrguer Artesanal', unit: 'Kg', standardCost: 8.50, sellingPrice: 12.80, expectedYield: 95 },
            { id: 'P002', name: 'Peito de Frango', unit: 'Kg', standardCost: 6.00, sellingPrice: 8.50, expectedYield: 98 },
            { id: 'P003', name: 'Pão Integral', unit: 'Kg', standardCost: 4.00, sellingPrice: 6.20, expectedYield: 99 },
            { id: 'P004', name: 'Queijo Minas', unit: 'Kg', standardCost: 12.00, sellingPrice: 18.90, expectedYield: 97 }
        ];

        let suppliersData = [
            { id: 'S01', company: 'Frigorífico Aurora', contact: 'João Silva', phone: '(11) 98765-4321', email: 'joao@aurora.com', products: 'Carne Bovina, Aves' }
        ];

        let employeesData = [
            { id: 'E01', name: 'Maria Souza', role: 'Operadora de Produção', phone: '(11) 91234-5678', email: 'maria.s@vilafrios.com' },
            { id: 'E02', name: 'Carlos Almeida', role: 'Supervisor de Produção', phone: '(11) 99876-5432', email: 'carlos.a@vilafrios.com' }
        ];

        let goalsData = [
            { id: 'G01', period: 'Mensal (Jul/2025)', type: 'Produção Total (kg)', reference: 'Todos', targetValue: 3000, currentValue: 2345, progress: '78%' },
            { id: 'G02', period: 'Trimestral (Q3/2025)', type: 'Perda Máxima (%)', reference: 'Todos', targetValue: 2, currentValue: 1.8, progress: 'atingida' }
        ];

        let usersData = [
            { id: 'U01', name: 'Admin User', email: 'admin@vilafrios.com', profile: 'Administrador', status: 'Ativo' }
        ];

        // Chart.js instance
        let productionChart;

        // --- Sidebar Toggle ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                content.style.marginLeft = '70px';
            } else {
                content.style.marginLeft = '256px';
            }
        });

        // Menu mobile
        mobileMenuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            sidebarOverlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            sidebarOverlay.style.display = 'none';
        });

        // Fechar menu ao clicar em um item (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.style.display = 'none';
                }
            });
        });

        // --- Navigation and Content Switching ---
        navItems.forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                // Remove active class from all
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');

                const targetContentId = this.dataset.content;
                const targetContent = document.getElementById(targetContentId);

                // Hide all content sections
                document.querySelectorAll('main > div').forEach(div => {
                    div.classList.add('hidden-content');
                });

                // Show target content
                targetContent.classList.remove('hidden-content');
                pageTitle.textContent = this.querySelector('.nav-text').textContent;

                // Load data specific to the section
                if (targetContentId === 'dashboard-content') {
                    renderDashboard();
                    updateProductionChart();
                } else if (targetContentId === 'products-content') {
                    renderProductsTable();
                } else if (targetContentId === 'suppliers-content') {
                    renderSuppliersTable();
                } else if (targetContentId === 'employees-content') {
                    renderEmployeesTable();
                } else if (targetContentId === 'production-content') {
                    renderDetailedProductionTable();
                    populateProductionFilters();
                } else if (targetContentId === 'goals-content') {
                    renderGoalsTable();
                } else if (targetContentId === 'users-content') {
                    renderUsersTable();
                }
            });
        });

        // --- Dashboard Functions ---
        function calculateProductionMetrics() {
            const today = new Date().toISOString().slice(0, 10);
            let dailyProduction = 0;
            let dailyLosses = 0;
            let totalProfitability = 0;
            let profitableProductionsCount = 0;

            productionData.forEach(prod => {
                const losses = prod.gross - prod.net - prod.shrinkage;
                const lossesPercentage = (losses / prod.gross) * 100;
                let profitability = 0;

                const productInfo = productsData.find(p => p.name === prod.product);
                if (productInfo) {
                    const costOfGoods = prod.rawMaterialCost; // Simplified: just raw material cost for demo
                    const revenue = prod.net * productInfo.sellingPrice;
                    if (revenue > 0) {
                        profitability = ((revenue - costOfGoods) / revenue) * 100;
                    }
                }

                if (prod.date === today) {
                    dailyProduction += prod.net;
                    dailyLosses += losses;
                }
                if (!isNaN(profitability) && profitability >= 0) { // Only count valid profitability
                    totalProfitability += profitability;
                    profitableProductionsCount++;
                }
            });

            const avgProfitability = profitableProductionsCount > 0 ? (totalProfitability / profitableProductionsCount) : 0;

            document.getElementById('daily-production').textContent = `${dailyProduction.toFixed(2)} kg`;
            document.getElementById('daily-losses').textContent = `${dailyLosses.toFixed(2)} kg`;
            document.getElementById('avg-profitability').textContent = `${avgProfitability.toFixed(2)}%`;

            // Monthly Goal (example - would come from goalsData)
            const monthlyGoal = goalsData.find(g => g.type === 'Produção Total (kg)' && g.period.includes('Jul/2025'));
            if (monthlyGoal) {
                const progress = (monthlyGoal.currentValue / monthlyGoal.targetValue) * 100;
                document.getElementById('monthly-goal-progress').textContent = `${progress.toFixed(0)}%`;
                document.getElementById('monthly-goal-bar').style.width = `${Math.min(progress, 100)}%`;
            } else {
                document.getElementById('monthly-goal-progress').textContent = `N/A`;
                document.getElementById('monthly-goal-bar').style.width = `0%`;
            }

            renderTopProducts();
        }

        function renderTopProducts() {
            const productAggregates = {}; // { productName: { totalNet: 0, totalLosses: 0, totalProfit: 0, count: 0 } }

            productionData.forEach(prod => {
                const losses = prod.gross - prod.net - prod.shrinkage;
                const productInfo = productsData.find(p => p.name === prod.product);
                let profitability = 0;
                if (productInfo) {
                    const costOfGoods = prod.rawMaterialCost;
                    const revenue = prod.net * productInfo.sellingPrice;
                    if (revenue > 0) {
                        profitability = ((revenue - costOfGoods) / revenue) * 100;
                    }
                }

                if (!productAggregates[prod.product]) {
                    productAggregates[prod.product] = { totalNet: 0, totalLosses: 0, totalProfitability: 0, count: 0 };
                }
                productAggregates[prod.product].totalNet += prod.net;
                productAggregates[prod.product].totalLosses += losses;
                productAggregates[prod.product].totalProfitability += profitability;
                productAggregates[prod.product].count++;
            });

            const sortedProducts = Object.entries(productAggregates)
                .map(([name, data]) => ({
                    name,
                    totalNet: data.totalNet,
                    avgLosses: data.totalLosses / data.count,
                    avgProfitability: data.totalProfitability / data.count,
                    productInfo: productsData.find(p => p.name === name)
                }))
                .sort((a, b) => b.totalNet - a.totalNet) // Sort by total production
                .slice(0, 4); // Top 4 products

            topProductsList.innerHTML = '';
            sortedProducts.forEach(product => {
                const productIcon = getProductIcon(product.name);
                const priceText = product.productInfo ? `R$ ${product.productInfo.sellingPrice.toFixed(2)}/kg` : '';
                const profitColor = product.avgProfitability >= 0 ? 'text-green-500' : 'text-red-500';
                const profitArrow = product.avgProfitability >= 0 ? 'fa-caret-up' : 'fa-caret-down';

                topProductsList.innerHTML += `
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                            <i class="fas ${productIcon} text-blue-600"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-medium">${product.name}</p>
                            <p class="text-sm text-gray-500">${priceText}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-medium">${product.totalNet.toFixed(2)} kg</p>
                            <p class="text-sm ${profitColor}"><i class="fas ${profitArrow}"></i> ${product.avgProfitability.toFixed(1)}%</p>
                        </div>
                    </div>
                `;
            });
        }

        function getProductIcon(productName) {
            switch (productName) {
                case 'Hambúrguer Artesanal': return 'fa-hamburger';
                case 'Peito de Frango': return 'fa-drumstick-bite';
                case 'Pão Integral': return 'fa-bread-slice';
                case 'Queijo Minas': return 'fa-cheese';
                default: return 'fa-box-open';
            }
        }

        function updateProductionChart() {
            const ctx = document.getElementById('productionChart').getContext('2d');
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6); // Last 7 days including today

            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(sevenDaysAgo);
                d.setDate(sevenDaysAgo.getDate() + i);
                dates.push(d.toISOString().slice(0, 10));
            }

            const dailyProduction = dates.map(date => {
                let total = 0;
                productionData.filter(p => p.date === date).forEach(p => total += p.net);
                return total;
            });

            const dailyLosses = dates.map(date => {
                let totalLoss = 0;
                productionData.filter(p => p.date === date).forEach(p => totalLoss += (p.gross - p.net - p.shrinkage));
                return totalLoss;
            });

            if (productionChart) {
                productionChart.destroy(); // Destroy previous chart instance
            }

            productionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => new Date(d).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' })),
                    datasets: [
                        {
                            label: 'Produção Líquida (kg)',
                            data: dailyProduction,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Perdas (kg)',
                            data: dailyLosses,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            tension: 0.1,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(2)} kg`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Production Modals and Forms ---
        newProductionBtn.addEventListener('click', () => {
            openProductionModal();
        });

        addProductionRecordBtn.addEventListener('click', () => {
            openProductionModal();
        });

        closeProductionModal.addEventListener('click', () => {
            newProductionModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == newProductionModal) {
                newProductionModal.style.display = 'none';
            }
            if (event.target == genericModal) {
                genericModal.style.display = 'none';
            }
        });

        function openProductionModal() {
            newProductionModal.style.display = 'block';
            productionForm.reset(); // Clear form
            rawMaterialsList.innerHTML = ''; // Clear raw materials
            addRawMaterialInput(); // Add first raw material input
        }

        addRawMaterialBtn.addEventListener('click', () => {
            addRawMaterialInput();
        });

        function addRawMaterialInput(materialName = '', quantity = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Nome Matéria-Prima" value="${materialName}" class="flex-grow border rounded-md p-2 raw-material-name form-control" required>
                <input type="number" step="0.01" placeholder="Quantidade (kg/un)" value="${quantity}" class="w-28 border rounded-md p-2 raw-material-quantity form-control" required>
                <input type="number" step="0.01" placeholder="Custo (R$)" class="w-28 border rounded-md p-2 raw-material-cost form-control" required>
                <button type="button" class="remove-raw-material-btn text-red-600 hover:text-red-800 p-2 action-btn">
                    <i class="fas fa-times"></i>
                </button>
            `;
            rawMaterialsList.appendChild(div);

            div.querySelector('.remove-raw-material-btn').addEventListener('click', (e) => {
                e.target.closest('div').remove();
            });
        }

        productionForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const prodDate = document.getElementById('prod-date').value;
            const prodProductSelect = document.getElementById('prod-product');
            const prodProduct = prodProductSelect.value;
            const prodLot = document.getElementById('prod-lot').value;
            const prodEmployee = document.getElementById('prod-employee').value;
            const prodGrossWeight = parseFloat(document.getElementById('prod-gross-weight').value);
            const prodNetWeight = parseFloat(document.getElementById('prod-net-weight').value);
            const prodShrinkage = parseFloat(document.getElementById('prod-shrinkage').value);

            let totalRawMaterialCost = 0;
            document.querySelectorAll('.raw-material-cost').forEach(input => {
                totalRawMaterialCost += parseFloat(input.value) || 0;
            });

            const losses = prodGrossWeight - prodNetWeight - prodShrinkage;
            const lossesPercentage = ((losses / prodGrossWeight) * 100).toFixed(1);

            const productInfo = productsData.find(p => p.name === prodProduct);
            let profitability = 0;
            if (productInfo) {
                const revenue = prodNetWeight * productInfo.sellingPrice;
                if (revenue > 0) {
                    profitability = ((revenue - totalRawMaterialCost) / revenue) * 100;
                }
            }

            const newProductionRecord = {
                id: `prod${Date.now()}`, // Simple unique ID for demo
                date: prodDate,
                product: prodProduct,
                lot: prodLot,
                employee: prodEmployee,
                gross: prodGrossWeight,
                net: prodNetWeight,
                shrinkage: prodShrinkage,
                rawMaterialCost: totalRawMaterialCost,
                lossesPercentage: lossesPercentage,
                profitability: profitability.toFixed(1)
            };

            productionData.unshift(newProductionRecord); // Add to beginning for "latest" view
            renderDetailedProductionTable(); // Refresh the table
            renderDashboard(); // Update dashboard metrics

            newProductionModal.style.display = 'none';
            alert('Produção registrada com sucesso!');
        });

        // --- Render Tables ---
        function renderDetailedProductionTable() {
            detailedProductionTableBody.innerHTML = ''; // Clear existing rows

            const filterDate = document.getElementById('prod-filter-date').value;
            const filterProduct = document.getElementById('prod-filter-product').value;
            const filterEmployee = document.getElementById('prod-filter-employee').value;

            const filteredData = productionData.filter(prod => {
                let matchDate = true;
                if (filterDate) {
                    matchDate = prod.date === filterDate;
                }
                let matchProduct = true;
                if (filterProduct) {
                    matchProduct = prod.product === filterProduct;
                }
                let matchEmployee = true;
                if (filterEmployee) {
                    matchEmployee = prod.employee === filterEmployee;
                }
                return matchDate && matchProduct && matchEmployee;
            });


            filteredData.forEach(prod => {
                const row = detailedProductionTableBody.insertRow();
                row.innerHTML = `
                    <td>${new Date(prod.date).toLocaleDateString('pt-BR')}</td>
                    <td>${prod.product}</td>
                    <td>${prod.lot || '-'}</td>
                    <td>${prod.gross.toFixed(2)} kg</td>
                    <td>${prod.net.toFixed(2)} kg</td>
                    <td>${prod.shrinkage.toFixed(2)} kg</td>
                    <td>${prod.lossesPercentage}%</td>
                    <td>R$ ${prod.rawMaterialCost.toFixed(2)}</td>
                    <td>${prod.profitability}%</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editProduction('${prod.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteProduction('${prod.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }

        function populateProductionFilters() {
            const productFilter = document.getElementById('prod-filter-product');
            const employeeFilter = document.getElementById('prod-filter-employee');

            // Clear previous options (keep default "Todos")
            productFilter.innerHTML = '<option value="">Todos os Produtos</option>';
            employeeFilter.innerHTML = '<option value="">Todos os Colaboradores</option>';

            const uniqueProducts = [...new Set(productsData.map(p => p.name))];
            uniqueProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilter.appendChild(option);
            });

            const uniqueEmployees = [...new Set(employeesData.map(e => e.name))];
            uniqueEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeFilter.appendChild(option);
            });

            // Add event listeners for filters
            document.getElementById('prod-filter-date').addEventListener('change', renderDetailedProductionTable);
            document.getElementById('prod-filter-product').addEventListener('change', renderDetailedProductionTable);
            document.getElementById('prod-filter-employee').addEventListener('change', renderDetailedProductionTable);
        }

        // Dummy functions for edit/delete (would interact with backend)
        function editProduction(id) {
            alert(`Editar produção com ID: ${id}`);
            // Logic to load production data into the modal for editing
        }
        function deleteProduction(id) {
            if (confirm(`Tem certeza que deseja excluir a produção com ID: ${id}?`)) {
                productionData = productionData.filter(p => p.id !== id);
                renderDetailedProductionTable();
                renderDashboard();
            }
        }

        // Generic Modal Handlers for other sections
        function openGenericModal(type, title, formHtml, onSubmitCallback) {
            genericModalTitle.textContent = title;
            genericForm.innerHTML = formHtml + '<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full btn btn-primary">Salvar</button>';
            genericForm.onsubmit = (e) => {
                e.preventDefault();
                onSubmitCallback(e);
                genericModal.style.display = 'none';
            };
            genericModal.style.display = 'block';
        }

        closeGenericModal.addEventListener('click', () => {
            genericModal.style.display = 'none';
        });

        // --- Products Section ---
        document.getElementById('new-product-btn').addEventListener('click', () => {
            const formHtml = `
                <div>
                    <label for="product-name" class="block text-sm font-medium text-gray-700">Nome do Produto:</label>
                    <input type="text" id="product-name" class="mt-1 block w-full border rounded-md p-2 form-control" required>
                </div>
                <div>
                    <label for="product-unit" class="block text-sm font-medium text-gray-700">Unidade de Medida:</label>
                    <input type="text" id="product-unit" class="mt-1 block w-full border rounded-md p-2 form-control" placeholder="Ex: Kg, Un" required>
                </div>
                <div>
                    <label for="product-cost" class="block text-sm font-medium text-gray-700">Custo Padrão (R$/kg/un):</label>
                    <input type="number" id="product-cost" step="0.01" class="mt-1 block w-full border rounded-md p-2 form-control" required>
                </div>
                <div>
                    <label for="product-price" class="block text-sm font-medium text-gray-700">Preço Venda (R$/kg/un):</label>
                    <input type="number" id="product-price" step="0.01" class="mt-1 block w-full border rounded-md p-2 form-control" required>
                </div>
                <div>
                    <label for="product-yield" class="block text-sm font-medium text-gray-700">Rendimento Esperado (%):</label>
                    <input type="number" id="product-yield" step="0.01" class="mt-1 block w-full border rounded-md p-2 form-control" required>
                </div>
            `;
            openGenericModal('product', 'Novo Produto', formHtml, (e) => {
                const newProduct = {
                    id: `P${Date.now()}`,
                    name: document.getElementById('product-name').value,
                    unit: document.getElementById('product-unit').value,
                    standardCost: parseFloat(document.getElementById('product-cost').value),
                    sellingPrice: parseFloat(document.getElementById('product-price').value),
                    expectedYield: parseFloat(document.getElementById('product-yield').value)
                };
                productsData.push(newProduct);
                renderProductsTable();
                alert('Produto adicionado!');
            });
        });

        function renderProductsTable() {
            const productsTableBody = document.getElementById('products-table-body');
            productsTableBody.innerHTML = '';
            productsData.forEach(product => {
                const row = productsTableBody.insertRow();
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.unit}</td>
                    <td>${product.standardCost.toFixed(2)}</td>
                    <td>${product.sellingPrice.toFixed(2)}</td>
                    <td>${product.expectedYield}%</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editProduct('${product.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteProduct('${product.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }
        function editProduct(id) { alert(`Editar produto com ID: ${id}`); }
        function deleteProduct(id) { if (confirm(`Excluir produto ${id}?`)) { productsData = productsData.filter(p => p.id !== id); renderProductsTable(); } }

        // --- Suppliers Section ---
        document.getElementById('new-supplier-btn').addEventListener('click', () => {
            const formHtml = `
                <div><label for="supplier-company">Empresa:</label><input type="text" id="supplier-company" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="supplier-contact">Contato:</label><input type="text" id="supplier-contact" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
                <div><label for="supplier-phone">Telefone:</label><input type="text" id="supplier-phone" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
                <div><label for="supplier-email">Email:</label><input type="email" id="supplier-email" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
                <div><label for="supplier-products">Produtos Fornecidos:</label><input type="text" id="supplier-products" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
            `;
            openGenericModal('supplier', 'Novo Fornecedor', formHtml, (e) => {
                const newSupplier = {
                    id: `S${Date.now()}`, company: document.getElementById('supplier-company').value,
                    contact: document.getElementById('supplier-contact').value, phone: document.getElementById('supplier-phone').value,
                    email: document.getElementById('supplier-email').value, products: document.getElementById('supplier-products').value
                };
                suppliersData.push(newSupplier); renderSuppliersTable(); alert('Fornecedor adicionado!');
            });
        });
        function renderSuppliersTable() {
            const suppliersTableBody = document.getElementById('suppliers-table-body');
            suppliersTableBody.innerHTML = '';
            suppliersData.forEach(supplier => {
                const row = suppliersTableBody.insertRow();
                row.innerHTML = `
                    <td>${supplier.id}</td><td>${supplier.company}</td><td>${supplier.contact}</td>
                    <td>${supplier.phone}</td><td>${supplier.email}</td><td>${supplier.products}</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editSupplier('${supplier.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteSupplier('${supplier.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }
        function editSupplier(id) { alert(`Editar fornecedor com ID: ${id}`); }
        function deleteSupplier(id) { if (confirm(`Excluir fornecedor ${id}?`)) { suppliersData = suppliersData.filter(s => s.id !== id); renderSuppliersTable(); } }

        // --- Employees Section ---
        document.getElementById('new-employee-btn').addEventListener('click', () => {
            const formHtml = `
                <div><label for="employee-name">Nome:</label><input type="text" id="employee-name" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="employee-role">Cargo:</label><input type="text" id="employee-role" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="employee-phone">Telefone:</label><input type="text" id="employee-phone" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
                <div><label for="employee-email">Email:</label><input type="email" id="employee-email" class="mt-1 block w-full border rounded-md p-2 form-control"></div>
            `;
            openGenericModal('employee', 'Novo Colaborador', formHtml, (e) => {
                const newEmployee = {
                    id: `E${Date.now()}`, name: document.getElementById('employee-name').value,
                    role: document.getElementById('employee-role').value, phone: document.getElementById('employee-phone').value,
                    email: document.getElementById('employee-email').value
                };
                employeesData.push(newEmployee); renderEmployeesTable(); alert('Colaborador adicionado!');
            });
        });
        function renderEmployeesTable() {
            const employeesTableBody = document.getElementById('employees-table-body');
            employeesTableBody.innerHTML = '';
            employeesData.forEach(employee => {
                const row = employeesTableBody.insertRow();
                row.innerHTML = `
                    <td>${employee.id}</td><td>${employee.name}</td><td>${employee.role}</td>
                    <td>${employee.phone}</td><td>${employee.email}</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editEmployee('${employee.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteEmployee('${employee.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }
        function editEmployee(id) { alert(`Editar colaborador com ID: ${id}`); }
        function deleteEmployee(id) { if (confirm(`Excluir colaborador ${id}?`)) { employeesData = employeesData.filter(e => e.id !== id); renderEmployeesTable(); } }

        // --- Goals Section ---
        document.getElementById('add-goal-btn').addEventListener('click', () => {
            const formHtml = `
                <div><label for="goal-period">Período:</label><input type="text" id="goal-period" class="mt-1 block w-full border rounded-md p-2 form-control" placeholder="Ex: Mensal (Jul/2025)" required></div>
                <div><label for="goal-type">Tipo de Meta:</label>
                    <select id="goal-type" class="mt-1 block w-full border rounded-md p-2 form-control">
                        <option value="Produção Total (kg)">Produção Total (kg)</option>
                        <option value="Perda Máxima (%)">Perda Máxima (%)</option>
                        <option value="Rentabilidade Média (%)">Rentabilidade Média (%)</option>
                    </select>
                </div>
                <div><label for="goal-reference">Referência (Ex: Todos, Produto X):</label><input type="text" id="goal-reference" class="mt-1 block w-full border rounded-md p-2 form-control" value="Todos"></div>
                <div><label for="goal-value">Valor Alvo:</label><input type="number" step="0.01" id="goal-value" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
            `;
            openGenericModal('goal', 'Nova Meta', formHtml, (e) => {
                const newGoal = {
                    id: `G${Date.now()}`, period: document.getElementById('goal-period').value,
                    type: document.getElementById('goal-type').value, reference: document.getElementById('goal-reference').value,
                    targetValue: parseFloat(document.getElementById('goal-value').value),
                    currentValue: 0, progress: '0%' // Will be calculated by backend
                };
                goalsData.push(newGoal); renderGoalsTable(); alert('Meta adicionada!');
            });
        });
        function renderGoalsTable() {
            const goalsTableBody = document.getElementById('goals-table-body');
            goalsTableBody.innerHTML = '';
            goalsData.forEach(goal => {
                const row = goalsTableBody.insertRow();
                row.innerHTML = `
                    <td>${goal.period}</td><td>${goal.type}</td><td>${goal.reference}</td>
                    <td>${goal.targetValue}${goal.type.includes('(kg)') ? ' kg' : '%'}</td><td>${goal.currentValue} ${goal.type.includes('(kg)') ? ' kg' : '%'} (${goal.progress})</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editGoal('${goal.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteGoal('${goal.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }
        function editGoal(id) { alert(`Editar meta com ID: ${id}`); }
        function deleteGoal(id) { if (confirm(`Excluir meta ${id}?`)) { goalsData = goalsData.filter(g => g.id !== id); renderGoalsTable(); } }

        // --- Users Section ---
        document.getElementById('new-user-btn').addEventListener('click', () => {
            const formHtml = `
                <div><label for="user-name">Nome:</label><input type="text" id="user-name" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="user-email">Email:</label><input type="email" id="user-email" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="user-password">Senha:</label><input type="password" id="user-password" class="mt-1 block w-full border rounded-md p-2 form-control" required></div>
                <div><label for="user-profile">Perfil de Acesso:</label>
                    <select id="user-profile" class="mt-1 block w-full border rounded-md p-2 form-control">
                        <option value="Administrador">Administrador</option>
                        <option value="Gerente de Produção">Gerente de Produção</option>
                        <option value="Operador de Produção">Operador de Produção</option>
                        <option value="Leitor">Leitor</option>
                    </select>
                </div>
            `;
            openGenericModal('user', 'Novo Usuário', formHtml, (e) => {
                const newUser = {
                    id: `U${Date.now()}`, name: document.getElementById('user-name').value,
                    email: document.getElementById('user-email').value, profile: document.getElementById('user-profile').value,
                    status: 'Ativo' // Default status
                };
                usersData.push(newUser); renderUsersTable(); alert('Usuário adicionado!');
            });
        });
        function renderUsersTable() {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';
            usersData.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `
                    <td>${user.id}</td><td>${user.name}</td><td>${user.email}</td>
                    <td>${user.profile}</td><td>${user.status}</td>
                    <td>
                        <button class="text-blue-600 hover:text-blue-800 mr-2 action-btn" onclick="editUser('${user.id}')"><i class="fas fa-edit"></i></button>
                        <button class="text-red-600 hover:text-red-800 action-btn" onclick="deleteUser('${user.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
        }
        function editUser(id) { alert(`Editar usuário com ID: ${id}`); }
        function deleteUser(id) { if (confirm(`Excluir usuário ${id}?`)) { usersData = usersData.filter(u => u.id !== id); renderUsersTable(); } }

        // --- Reports Section ---
        document.getElementById('generate-report-btn').addEventListener('click', generateReport);
        document.getElementById('export-report-btn').addEventListener('click', exportReport);

        function generateReport() {
            const reportType = document.getElementById('report-type').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const reportOutput = document.getElementById('report-output');

            let filteredProductions = productionData.filter(p => {
                const prodDate = new Date(p.date);
                const start = startDate ? new Date(startDate) : null;
                const end = endDate ? new Date(endDate) : null;
                return (!start || prodDate >= start) && (!end || prodDate <= end);
            });

            let reportContent = `<h3 class="text-lg font-semibold mb-2">Relatório Gerado:</h3>`;
            reportContent += `<p class="text-sm mb-4">Período: ${startDate || 'Início'} a ${endDate || 'Fim'}</p>`;

            if (reportType === 'production-summary') {
                let totalGross = 0;
                let totalNet = 0;
                let totalLosses = 0;

                filteredProductions.forEach(p => {
                    totalGross += p.gross;
                    totalNet += p.net;
                    totalLosses += (p.gross - p.net - p.shrinkage);
                });

                reportContent += `<p><strong>Produção Total Bruta:</strong> ${totalGross.toFixed(2)} kg</p>`;
                reportContent += `<p><strong>Produção Total Líquida:</strong> ${totalNet.toFixed(2)} kg</p>`;
                reportContent += `<p><strong>Total de Perdas:</strong> ${totalLosses.toFixed(2)} kg</p>`;
                reportContent += `<p><strong>Porcentagem Média de Perdas:</strong> ${totalGross > 0 ? ((totalLosses / totalGross) * 100).toFixed(2) : 0}%</p>`;

            } else if (reportType === 'losses-analysis') {
                reportContent += `<h4 class="font-medium mb-2">Análise Detalhada de Perdas por Produto:</h4>`;
                const productLosses = {};
                filteredProductions.forEach(p => {
                    const losses = p.gross - p.net - p.shrinkage;
                    if (!productLosses[p.product]) {
                        productLosses[p.product] = { totalLosses: 0, totalGross: 0 };
                    }
                    productLosses[p.product].totalLosses += losses;
                    productLosses[p.product].totalGross += p.gross;
                });

                if (Object.keys(productLosses).length === 0) {
                    reportContent += '<p class="text-gray-500">Nenhum dado de perda para o período.</p>';
                } else {
                    reportContent += `<table class="data-table"><thead><tr><th>Produto</th><th>Total Perdas (kg)</th><th>% sobre Bruto</th></tr></thead><tbody>`;
                    for (const product in productLosses) {
                        const lossPercent = (productLosses[product].totalGross > 0) ? ((productLosses[product].totalLosses / productLosses[product].totalGross) * 100).toFixed(2) : 0;
                        reportContent += `<tr><td>${product}</td><td>${productLosses[product].totalLosses.toFixed(2)}</td><td>${lossPercent}%</td></tr>`;
                    }
                    reportContent += `</tbody></table>`;
                }

            } else if (reportType === 'profitability-breakdown') {
                reportContent += `<h4 class="font-medium mb-2">Rentabilidade por Produto:</h4>`;
                const productProfitability = {};
                filteredProductions.forEach(p => {
                    const productInfo = productsData.find(prod => prod.name === p.product);
                    if (productInfo) {
                        const costOfGoods = p.rawMaterialCost;
                        const revenue = p.net * productInfo.sellingPrice;
                        let profitability = 0;
                        if (revenue > 0) {
                            profitability = ((revenue - costOfGoods) / revenue) * 100;
                        }

                        if (!productProfitability[p.product]) {
                            productProfitability[p.product] = { totalProfitability: 0, count: 0 };
                        }
                        productProfitability[p.product].totalProfitability += profitability;
                        productProfitability[p.product].count++;
                    }
                });

                if (Object.keys(productProfitability).length === 0) {
                    reportContent += '<p class="text-gray-500">Nenhum dado de rentabilidade para o período.</p>';
                } else {
                    reportContent += `<table class="data-table"><thead><tr><th>Produto</th><th>Rentabilidade Média (%)</th></tr></thead><tbody>`;
                    for (const product in productProfitability) {
                        const avgProfit = (productProfitability[product].count > 0) ? (productProfitability[product].totalProfitability / productProfitability[product].count).toFixed(2) : 0;
                        reportContent += `<tr><td>${product}</td><td>${avgProfit}%</td></tr>`;
                    }
                    reportContent += `</tbody></table>`;
                }
            }

            reportOutput.innerHTML = reportContent;
        }

        function exportReport() {
            const reportContent = document.getElementById('report-output').innerHTML;
            if (!reportContent.includes('Relatório Gerado')) {
                alert('Gere um relatório primeiro para exportar.');
                return;
            }

            // A simpler way for a demo: open in a new window for print/save
            const newWindow = window.open();
            newWindow.document.write(`
                <html>
                <head>
                    <title>Relatório Vila Frios</title>
                    <link rel="stylesheet" href="https://cdn.tailwindcss.com">
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        h1, h2, h3 { color: #333; }
                    </style>
                </head>
                <body>
                    <h1>Relatório Vila Frios</h1>
                    ${reportContent}
                </body>
                </html>
            `);
            newWindow.document.close();
            newWindow.print(); // Opens print dialog
        }

        // Feedback tátil para botões
        document.querySelectorAll('button, a').forEach(btn => {
            btn.addEventListener('touchstart', () => {
                btn.style.transform = 'scale(0.98)';
            });
            
            btn.addEventListener('touchend', () => {
                btn.style.transform = 'scale(1)';
            });
        });

        // Prevenir zoom duplo toque em botões
        document.addEventListener('dblclick', (e) => {
            if (['BUTTON', 'A'].includes(e.target.tagName)) {
                e.preventDefault();
            }
        }, { passive: false });

        // Melhorar a experiência de formulários em mobile
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('focus', () => {
                if (window.innerWidth <= 768) {
                    // Rolagem suave para o campo em foco
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });
        });

        // Detectar mudança de orientação
        window.addEventListener('orientationchange', () => {
            // Recarregar gráficos ao mudar a orientação
            if (productionChart) {
                productionChart.destroy();
                updateProductionChart();
            }
        });

        // Carregamento otimizado para mobile
        if ('connection' in navigator) {
            if (navigator.connection.saveData || navigator.connection.effectiveType.includes('2g')) {
                // Otimizações para conexões lentas
                document.querySelectorAll('img, iframe, video').forEach(media => {
                    media.loading = 'lazy';
                });
            }
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderDashboard(); // Render dashboard first
            updateProductionChart();
            
            // Verificar se é mobile e ajustar o menu
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('collapsed');
                sidebar.classList.add('active');
                content.style.marginLeft = '0';
            }
        });

        // Função auxiliar para renderizar o dashboard
        function renderDashboard() {
            calculateProductionMetrics();
            renderTopProducts();
        }
    </script>
</body>
</html>