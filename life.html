<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reserva Espaço Life Festas</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #004AAD;
      --primary-light: #3373d9;
      --secondary: #FF5722;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #F44336;
      --light: #F5F5F5;
      --dark: #212121;
      --gray: #757575;
      --white: #FFFFFF;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Poppins', sans-serif;
      background-color: #f9f9f9;
      color: var(--dark);
    }
    
    h1, h2, h3, h4 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
    }
    
    .background {
      background-color: var(--primary);
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-image: linear-gradient(135deg, rgba(0,74,173,0.9), rgba(0,74,173,0.7)), url('life.jpg');
      background-size: cover;
      background-position: center;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .header {
      text-align: center;
      padding: 30px 0;
    }
    
    .logo {
      max-height: 120px;
      margin-bottom: 15px;
      filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
    }
    
    .title {
      color: var(--white);
      margin-bottom: 10px;
      font-size: 2.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      color: var(--light);
      font-weight: 300;
      margin-bottom: 30px;
    }
    
    .content {
      margin: 20px auto 50px;
      max-width: 800px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: var(--radius) var(--radius) 0 0;
      overflow: hidden;
    }
    
    .tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      background-color: #e9e9e9;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab.active {
      background-color: var(--white);
      color: var(--primary);
      box-shadow: 0 -3px 0 var(--primary) inset;
    }
    
    .tab-content {
      display: none;
      padding: 25px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .btn-icon {
      margin-right: 8px;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-light);
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .month-selector {
      display: flex;
      align-items: center;
      font-weight: 500;
      font-size: 1.2rem;
    }
    
    .month-arrow {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--primary);
      padding: 0 15px;
    }
    
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      padding: 10px 0;
      color: var(--gray);
    }
    
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid #e0e0e0;
    }
    
    .calendar-day:hover {
      background-color: #f0f0f0;
    }
    
    .calendar-day.empty {
      background: transparent;
      border: none;
      cursor: default;
    }
    
    .calendar-day.reserved {
      background-color: var(--danger);
      color: var(--white);
      cursor: not-allowed;
      border-color: var(--danger);
    }
    
    .calendar-day.pending {
      background-color: var(--warning);
      color: var(--dark);
      border-color: var(--warning);
    }
    
    .calendar-day.selected {
      background-color: var(--success);
      color: var(--white);
      border-color: var(--success);
    }
    
    .tooltip {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: var(--white);
      padding: 5px 10px;
      border-radius: var(--radius);
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    
    .calendar-day:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }
    
    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .reservation-list {
      list-style: none;
      margin-top: 15px;
    }
    
    .reservation-item {
      padding: 15px;
      border-radius: var(--radius);
      background-color: #f5f5f5;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .reservation-date {
      font-weight: 500;
    }
    
    .reservation-actions {
      display: flex;
      gap: 10px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .badge-pending {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    .badge-confirmed {
      background-color: var(--success);
      color: var(--white);
    }
    
    .hidden {
      display: none;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--light);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: var(--radius);
      color: var(--white);
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast-success {
      background-color: var(--success);
    }
    
    .toast-error {
      background-color: var(--danger);
    }
    
    @media (max-width: 768px) {
      .title {
        font-size: 1.8rem;
      }
      
      .calendar-day {
        font-size: 0.9rem;
      }
      
      .action-bar {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="background"></div>
  
  <div class="container">
    <header class="header">
      <img src="life.png" alt="Logo Life Festas" class="logo">
      <h1 class="title">Reserva Espaço Life Festas</h1>
      <p class="subtitle">Escolha as datas para seu evento especial</p>
    </header>
    
    <main class="content">
      <div class="card">
        <div class="tabs">
          <div class="tab active" data-tab="calendar">Calendário</div>
          <div class="tab" data-tab="admin">Administrador</div>
        </div>
        
        <div class="tab-content active" id="calendar-tab">
          <div class="calendar-header">
            <div class="month-selector">
              <button class="month-arrow" id="prev-month">&#10094;</button>
              <span id="month-year">Maio 2025</span>
              <button class="month-arrow" id="next-month">&#10095;</button>
            </div>
          </div>
          
          <div class="calendar">
            <div class="calendar-weekday">Dom</div>
            <div class="calendar-weekday">Seg</div>
            <div class="calendar-weekday">Ter</div>
            <div class="calendar-weekday">Qua</div>
            <div class="calendar-weekday">Qui</div>
            <div class="calendar-weekday">Sex</div>
            <div class="calendar-weekday">Sáb</div>
            <!-- Calendar days will be inserted here by JavaScript -->
          </div>
          
          <div class="action-bar">
            <div>
              <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                  <div style="width: 15px; height: 15px; background-color: var(--success); border-radius: 3px;"></div>
                  <span>Selecionado</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <div style="width: 15px; height: 15px; background-color: var(--warning); border-radius: 3px;"></div>
                  <span>Pendente</span>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                  <div style="width: 15px; height: 15px; background-color: var(--danger); border-radius: 3px;"></div>
                  <span>Reservado</span>
                </div>
              </div>
            </div>
            <button class="btn btn-primary" id="reserve-btn">
              <span class="material-icons btn-icon">event_available</span>Reservar Datas
            </button>
          </div>
          
          <!-- Reservation Form Modal (hidden by default) -->
          <div id="reservation-modal" class="hidden">
            <div class="form-group">
              <label class="form-label" for="client-name">Nome Completo</label>
              <input type="text" id="client-name" class="form-control" placeholder="Digite seu nome completo">
            </div>
            <div class="form-group">
              <label class="form-label" for="client-phone">Telefone</label>
              <input type="tel" id="client-phone" class="form-control" placeholder="(00) 00000-0000">
            </div>
            <div class="form-group">
              <label class="form-label" for="client-email">Email</label>
              <input type="email" id="client-email" class="form-control" placeholder="seu@email.com">
            </div>
            <div class="form-group">
              <label class="form-label">Datas Selecionadas</label>
              <div id="selected-dates-list"></div>
            </div>
            <div class="action-bar">
              <button class="btn btn-outline" id="cancel-reservation">Cancelar</button>
              <button class="btn btn-primary" id="confirm-reservation">Confirmar Reserva</button>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="admin-tab">
          <div id="login-form">
            <div class="form-group">
              <label class="form-label" for="admin-user">Usuário</label>
              <input type="text" id="admin-user" class="form-control" placeholder="Nome de usuário">
            </div>
            <div class="form-group">
              <label class="form-label" for="admin-pass">Senha</label>
              <input type="password" id="admin-pass" class="form-control" placeholder="Senha">
            </div>
            <button class="btn btn-primary" id="login-btn">Entrar</button>
          </div>
          
          <div id="admin-panel" class="hidden">
            <h3>Gerenciar Reservas</h3>
            <div class="tabs" style="margin-top: 20px;">
              <div class="tab active" data-tab="pending">Pendentes</div>
              <div class="tab" data-tab="confirmed">Confirmadas</div>
            </div>
            
            <div class="tab-content active" id="pending-tab">
              <ul class="reservation-list" id="pending-list">
                <!-- Pending reservations will be inserted here -->
              </ul>
            </div>
            
            <div class="tab-content" id="confirmed-tab">
              <ul class="reservation-list" id="confirmed-list">
                <!-- Confirmed reservations will be inserted here -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <div id="toast" class="toast"></div>
  <div id="loading" class="loading hidden">
    <div class="loading-spinner"></div>
  </div>

  <!-- Supabase JS -->  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://sdsvbkobrcmqlyxmrxxv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkc3Zia29icmNtcWx5eG1yeHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNTUxNjAsImV4cCI6MjA2MjkzMTE2MH0.ICXhQKN1UIzcnyD1XDU00gvd8K8YxqYrrjH5DubyFGc';
    
    // Initialize Supabase client with improved configuration
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true
      },
      realtime: {
        params: {
          eventsPerSecond: 10
        }
      },
      db: {
        schema: 'public'
      }
    });

    // Test Supabase connection
    async function testSupabaseConnection() {
      try {
        showLoading();
        console.log('Testando conexão com Supabase...');
        
        // Test database connection
        const { data, error } = await supabase
          .from('reservas')
          .select('count()', { count: 'exact' })
          .limit(1);

        if (error) {
          throw error;
        }

        console.log('Conexão com banco de dados OK:', data);

        // Test realtime connection
        const channel = supabase
          .channel('connection-test')
          .subscribe((status) => {
            console.log('Status da conexão realtime:', status);
            if (status === 'SUBSCRIBED') {
              console.log('Conexão realtime OK');
              channel.unsubscribe();
            }
          });

        return true;
      } catch (error) {
        console.error('Erro na conexão com Supabase:', error);
        showToast('Erro na conexão com o servidor. Verifique o console para mais detalhes.', 'error');
        return false;
      } finally {
        hideLoading();
      }
    }

    // App state
    let today = new Date();
    let selectedDates = [];
    let reservations = {};
    let currentUser = null;
    
    // DOM Elements
    const calendarEl = document.querySelector('.calendar');
    const monthYearEl = document.getElementById('month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const reserveBtn = document.getElementById('reserve-btn');
    const reservationModal = document.getElementById('reservation-modal');
    const cancelReservationBtn = document.getElementById('cancel-reservation');
    const confirmReservationBtn = document.getElementById('confirm-reservation');
    const clientNameInput = document.getElementById('client-name');
    const clientPhoneInput = document.getElementById('client-phone');
    const clientEmailInput = document.getElementById('client-email');
    const selectedDatesList = document.getElementById('selected-dates-list');
    const loginBtn = document.getElementById('login-btn');
    const adminUserInput = document.getElementById('admin-user');
    const adminPassInput = document.getElementById('admin-pass');
    const adminPanel = document.getElementById('admin-panel');
    const loginForm = document.getElementById('login-form');
    const pendingList = document.getElementById('pending-list');
    const confirmedList = document.getElementById('confirmed-list');
    const loadingEl = document.getElementById('loading');
    const toastEl = document.getElementById('toast');
    
    // Utility functions
    function formatDateStr(date) {
      return date.toISOString().split('T')[0];
    }
    
    function formatDateBR(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    function showLoading() {
      loadingEl.classList.remove('hidden');
    }
    
    function hideLoading() {
      loadingEl.classList.add('hidden');
    }
    
    function showToast(message, type = 'success') {
      toastEl.textContent = message;
      toastEl.className = `toast toast-${type} show`;
      
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3000);
    }
    
    // Improved error handling function
    async function handleSupabaseError(error, operation) {
      console.error(`Error during ${operation}:`, error);
      if (error.code === 'PGRST301') {
        showToast('Sua sessão expirou. Por favor, faça login novamente.', 'error');
        // Handle session expiration
        currentUser = null;
        loginForm.classList.remove('hidden');
        adminPanel.classList.add('hidden');
      } else {
        showToast(`Erro ao ${operation}. ${error.message || 'Tente novamente.'}`, 'error');
      }
    }
    
    // Enhanced fetchReservations with better error handling
    async function fetchReservations() {
      showLoading();
      try {
        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .order('data', { ascending: true });
          
        if (error) throw error;
        
        // Convert array to object with date as key
        reservations = {};
        if (data && data.length > 0) {
          data.forEach(reservation => {
            reservations[reservation.data] = {
              id: reservation.id,
              date: reservation.data,
              client_name: reservation.nome_do_cliente,
              client_phone: reservation.telefone_do_cliente,
              client_email: reservation.e_mail,
              status: reservation.status,
              created_at: reservation.criado_em
            };
          });
          console.log('Reservas carregadas:', reservations);
        } else {
          console.log('Nenhuma reserva encontrada');
        }
        
        return reservations;
      } catch (error) {
        await handleSupabaseError(error, 'carregar reservas');
        return {};
      } finally {
        hideLoading();
      }
    }
    
    // Improved real-time subscription setup
    async function setupRealtimeSubscription() {
      try {
        // Remove any existing subscription
        await supabase.removeAllChannels();

        const channel = supabase
          .channel('public:reservas')
          .on('postgres_changes', { 
            event: '*', 
            schema: 'public', 
            table: 'reservas',
            filter: '*'
          }, async (payload) => {
            console.log('Mudança recebida:', payload);
            
            // Handle different types of changes
            switch (payload.eventType) {
              case 'INSERT':
                showToast('Nova reserva recebida!');
                break;
              case 'UPDATE':
                showToast('Reserva atualizada!');
                break;
              case 'DELETE':
                showToast('Reserva removida!');
                break;
            }

            // Refresh data
            await fetchReservations();
            await renderCalendar();
          })
          .subscribe((status) => {
            console.log('Status da inscrição:', status);
            if (status === 'SUBSCRIBED') {
              console.log('Conectado ao canal de tempo real');
            }
          });

        // Handle subscription errors
        channel.onError((err) => {
          console.error('Erro na conexão em tempo real:', err);
          showToast('Erro na sincronização em tempo real. Reconectando...', 'error');
          setTimeout(setupRealtimeSubscription, 5000); // Retry after 5 seconds
        });

      } catch (error) {
        console.error('Erro ao configurar sincronização em tempo real:', error);
        showToast('Erro ao configurar sincronização em tempo real', 'error');
      }
    }
    
    // Enhanced submitReservation with validation and error handling
    async function submitReservation() {
      // Enhanced validation
      const name = clientNameInput.value.trim();
      const phone = clientPhoneInput.value.trim();
      const email = clientEmailInput.value.trim();

      if (!name) {
        showToast('Por favor, informe seu nome', 'error');
        clientNameInput.focus();
        return;
      }
      
      if (!phone) {
        showToast('Por favor, informe seu telefone', 'error');
        clientPhoneInput.focus();
        return;
      }

      // Validate phone format
      const phoneRegex = /^\(\d{2}\)\s?\d{4,5}-\d{4}$/;
      if (!phoneRegex.test(phone)) {
        showToast('Formato de telefone inválido. Use (XX) XXXXX-XXXX', 'error');
        clientPhoneInput.focus();
        return;
      }

      // Validate email if provided
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Formato de e-mail inválido', 'error');
        clientEmailInput.focus();
        return;
      }
      
      showLoading();
      
      try {
        // Check for conflicting reservations first
        const { data: existingReservations, error: checkError } = await supabase
          .from('reservas')
          .select('data')
          .in('data', selectedDates)
          .eq('status', 'confirmed');

        if (checkError) throw checkError;

        if (existingReservations?.length > 0) {
          const conflictDates = existingReservations.map(r => formatDateBR(r.data)).join(', ');
          showToast(`As datas ${conflictDates} já estão reservadas`, 'error');
          return;
        }

        // Create reservations for each selected date
        const reservationPromises = selectedDates.map(date => 
          supabase
            .from('reservas')
            .insert([{
              data: date,
              nome_do_cliente: name,
              telefone_do_cliente: phone,
              e_mail: email,
              status: 'pending',
              criado_em: new Date().toISOString()
            }])
        );
        
        const results = await Promise.all(reservationPromises);
        const errors = results.filter(r => r.error);

        if (errors.length > 0) {
          throw errors[0].error;
        }
        
        // Success - clear form and selected dates
        showToast('Reserva solicitada com sucesso!');
        reservationModal.classList.add('hidden');
        
        // Store info for WhatsApp message
        const datesToFormat = [...selectedDates];
        
        // Clear form and selection
        selectedDates = [];
        clientNameInput.value = '';
        clientPhoneInput.value = '';
        clientEmailInput.value = '';
        
        // Refresh calendar
        await fetchReservations();
        renderCalendar();
        
        // Open WhatsApp with reservation details
        const formattedDates = datesToFormat.map(date => formatDateBR(date)).join(', ');
        const msg = `Olá! Eu, ${name}, gostaria de reservar o espaço Life Festas nas datas: ${formattedDates}. Telefone: ${phone}`;
        const url = `https://wa.me/5581981521109?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
      } catch (error) {
        await handleSupabaseError(error, 'criar reserva');
      } finally {
        hideLoading();
      }
    }
    
    async function loginAdmin() {
      const username = adminUserInput.value.trim();
      const password = adminPassInput.value.trim();
      
      if (!username || !password) {
        showToast('Por favor, preencha todos os campos', 'error');
        return;
      }
      
      showLoading();
      
      try {
        // In a real application, you would authenticate with Supabase Auth
        // For this demo, we'll use a simple check
        if (username === 'admin' && password === 'senha123') {
          currentUser = { role: 'admin' };
          loginForm.classList.add('hidden');
          adminPanel.classList.remove('hidden');
          await loadAdminData();
          showToast('Login realizado com sucesso!');
        } else {
          showToast('Usuário ou senha inválidos', 'error');
        }
      } catch (error) {
        console.error('Login error:', error);
        showToast('Erro ao fazer login', 'error');
      } finally {
        hideLoading();
        adminUserInput.value = '';
        adminPassInput.value = '';
      }
    }
    
    async function loadAdminData() {
      showLoading();
      
      try {
        // Fetch all reservations
        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .order('data', { ascending: true });
          
        if (error) throw error;
        
        // Clear lists
        pendingList.innerHTML = '';
        confirmedList.innerHTML = '';
        
        // Populate lists
        data.forEach(reservation => {
          const listItem = document.createElement('li');
          listItem.className = 'reservation-item';
          
          const dateInfo = document.createElement('div');
          dateInfo.className = 'reservation-date';
          dateInfo.innerHTML = `
            <strong>${formatDateBR(reservation.data)}</strong><br>
            <span>${reservation.nome_do_cliente}</span><br>
            <small>${reservation.telefone_do_cliente}</small>
          `;
          
          const statusBadge = document.createElement('span');
          statusBadge.className = `badge badge-${reservation.status === 'confirmed' ? 'confirmed' : 'pending'}`;
          statusBadge.textContent = reservation.status === 'confirmed' ? 'Confirmado' : 'Pendente';
          
          const actions = document.createElement('div');
          actions.className = 'reservation-actions';
          
          if (reservation.status === 'pending') {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.textContent = 'Confirmar';
            confirmBtn.addEventListener('click', () => confirmReservation(reservation.id));
            
            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'btn btn-outline';
            rejectBtn.textContent = 'Recusar';
            rejectBtn.addEventListener('click', () => deleteReservation(reservation.id));
            
            actions.appendChild(confirmBtn);
            actions.appendChild(rejectBtn);
            
            listItem.appendChild(dateInfo);
            listItem.appendChild(actions);
            pendingList.appendChild(listItem);
          } else {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-outline';
            deleteBtn.textContent = 'Cancelar';
            deleteBtn.addEventListener('click', () => deleteReservation(reservation.id));
            
            actions.appendChild(deleteBtn);
            
            listItem.appendChild(dateInfo);
            listItem.appendChild(statusBadge);
            listItem.appendChild(actions);
            confirmedList.appendChild(listItem);
          }
        });
        
        // Show empty message if no reservations
        if (pendingList.children.length === 0) {
          pendingList.innerHTML = '<p>Não há reservas pendentes.</p>';
        }
        
        if (confirmedList.children.length === 0) {
          confirmedList.innerHTML = '<p>Não há reservas confirmadas.</p>';
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
        showToast('Erro ao carregar dados', 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function confirmReservation(id) {
      showLoading();
      
      try {
        const { error } = await supabase
          .from('reservas')
          .update({ status: 'confirmed' })
          .eq('id', id);
          
        if (error) throw error;
        
        showToast('Reserva confirmada com sucesso!');
        await loadAdminData();
        await fetchReservations();
        renderCalendar();
      } catch (error) {
        console.error('Error confirming reservation:', error);
        showToast('Erro ao confirmar reserva', 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function deleteReservation(id) {
      if (!confirm('Tem certeza que deseja cancelar esta reserva?')) return;
      
      showLoading();
      
      try {
        const { error } = await supabase
          .from('reservas')
          .delete()
          .eq('id', id);
          
        if (error) throw error;
        
        showToast('Reserva cancelada com sucesso!');
        await loadAdminData();
        await fetchReservations();
        renderCalendar();
      } catch (error) {
        console.error('Error deleting reservation:', error);
        showToast('Erro ao cancelar reserva', 'error');
      } finally {
        hideLoading();
      }
    }
    
    // Calendar functions
    async function renderCalendar() {
      // Clear calendar days (but keep weekday headers)
      const dayElements = calendarEl.querySelectorAll('.calendar-day');
      dayElements.forEach(el => el.remove());
      
      // Set month and year display
      monthYearEl.textContent = today.toLocaleDateString('pt-BR', {
        month: 'long', 
        year: 'numeric'
      });
      
      // Get first and last day of month
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      // Add empty cells for days before start of month
      const startDayOfWeek = firstDay.getDay();
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendarEl.appendChild(emptyDay);
      }
      
      // Add days of month
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const date = new Date(today.getFullYear(), today.getMonth(), i);
        const dateStr = formatDateStr(date);
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = i;
        dayEl.dataset.date = dateStr;
        
        // Check reservation status
        if (reservations[dateStr]) {
          const reservation = reservations[dateStr];
          
          if (reservation.status === 'confirmed') {
            dayEl.classList.add('reserved');
            
            // Add tooltip with client name
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = `Reservado: ${reservation.client_name}`;
            dayEl.appendChild(tooltip);
          } else if (reservation.status === 'pending') {
            dayEl.classList.add('pending');
            
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = 'Reserva pendente';
            dayEl.appendChild(tooltip);
          }
        } else {
          // Only allow selection of future dates
          const currentDate = new Date();
          currentDate.setHours(0, 0, 0, 0);
          
          if (date >= currentDate) {
            dayEl.addEventListener('click', () => toggleDateSelection(dateStr));
            
            // Check if date is selected
            if (selectedDates.includes(dateStr)) {
              dayEl.classList.add('selected');
            }
          }
        }
        
        calendarEl.appendChild(dayEl);
      }
    }
    
    function toggleDateSelection(dateStr) {
      const index = selectedDates.indexOf(dateStr);
      
      if (index >= 0) {
        // Remove date if already selected
        selectedDates.splice(index, 1);
      } else {
        // Add date to selection
        selectedDates.push(dateStr);
      }
      
      // Update calendar UI
      renderCalendar();
      
      // Enable/disable reserve button
      reserveBtn.disabled = selectedDates.length === 0;
    }
    
    function changeMonth(offset) {
      today.setMonth(today.getMonth() + offset);
      renderCalendar();
    }
    
    function showReservationModal() {
      if (selectedDates.length === 0) {
        showToast('Selecione pelo menos uma data', 'error');
        return;
      }
      
      // Display selected dates
      selectedDatesList.innerHTML = '';
      selectedDates.sort().forEach(date => {
        const dateItem = document.createElement('div');
        dateItem.className = 'reservation-item';
        dateItem.textContent = formatDateBR(date);
        selectedDatesList.appendChild(dateItem);
      });
      
      // Show modal
      reservationModal.classList.remove('hidden');
      clientNameInput.focus();
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Test connection first
        const isConnected = await testSupabaseConnection();
        if (!isConnected) {
          showToast('Erro na conexão com o servidor. Verifique suas credenciais.', 'error');
          return;
        }

        // Initialize Supabase session
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (session) {
          currentUser = { role: 'admin' };
          loginForm.classList.add('hidden');
          adminPanel.classList.remove('hidden');
          await loadAdminData();
        }

        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            const tabContent = document.getElementById(`${tabName}-tab`);
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Activate selected tab
            tab.classList.add('active');
            tabContent.classList.add('active');
          });
        });
        
        // Admin panel tabs
        document.querySelectorAll('.tabs .tab[data-tab="pending"], .tabs .tab[data-tab="confirmed"]').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            
            // Deactivate all tabs
            document.querySelectorAll('.tabs .tab[data-tab="pending"], .tabs .tab[data-tab="confirmed"]').forEach(t => {
              t.classList.remove('active');
            });
            document.querySelectorAll('#pending-tab, #confirmed-tab').forEach(c => {
              c.classList.remove('active');
            });
            
            // Activate selected tab
            tab.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
          });
        });
        
        // Month navigation
        prevMonthBtn.addEventListener('click', () => changeMonth(-1));
        nextMonthBtn.addEventListener('click', () => changeMonth(1));
        
        // Reservation button
        reserveBtn.addEventListener('click', showReservationModal);
        
        // Reservation form
        cancelReservationBtn.addEventListener('click', () => {
          reservationModal.classList.add('hidden');
        });
        
        confirmReservationBtn.addEventListener('click', submitReservation);
        
        // Admin login
        loginBtn.addEventListener('click', loginAdmin);
        
        // Initialize app
        await fetchReservations();
        renderCalendar();
        setupRealtimeSubscription();
      } catch (error) {
        console.error('Error initializing app:', error);
        showToast('Erro ao inicializar o aplicativo', 'error');
      }
    });
  </script>
</body>
</html>
