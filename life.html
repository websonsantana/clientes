<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reserva Espaço Life Festas</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #004AAD;
      --primary-light: #3373d9;
      --secondary: #FF5722;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #F44336;
      --light: #F5F5F5;
      --dark: #212121;
      --gray: #757575;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Montserrat', sans-serif;
    }
    
    .background {
      background-image: linear-gradient(135deg, rgba(0,74,173,0.9), rgba(0,74,173,0.7)), url('life.jpg');
    }
    
    /* Custom tooltip */
    .tooltip {
      visibility: hidden;
      opacity: 0;
      transition: all 0.2s ease;
    }
    
    .calendar-day:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    /* Loading spinner animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Toast animation */
    .toast {
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- Background -->
  <div class="background fixed inset-0 -z-10 bg-cover bg-center"></div>
  
  <!-- Main Container -->
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <img src="life.png" alt="Logo Life Festas" class="mx-auto h-28 mb-4 drop-shadow-lg">
      <h1 class="text-4xl font-bold text-white mb-2 drop-shadow-md">Reserva Espaço Life Festas</h1>
      <p class="text-lg text-white/90 font-light">Escolha as datas para seu evento especial</p>
    </header>
    
    <!-- Main Content -->
    <main class="max-w-4xl mx-auto">
      <!-- Card Container -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Tabs Navigation -->
        <div class="flex border-b">
          <button data-tab="calendar" class="tab flex-1 py-4 px-6 text-center font-medium bg-gray-100 text-primary cursor-pointer transition-all">
            Calendário
          </button>
          <button data-tab="admin" class="tab flex-1 py-4 px-6 text-center font-medium bg-gray-100 text-gray-600 cursor-pointer transition-all">
            Administrador
          </button>
        </div>
        
        <!-- Calendar Tab Content -->
        <div id="calendar-tab" class="tab-content p-6">
          <!-- Calendar Header -->
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center text-xl font-medium">
              <button id="prev-month" class="p-2 text-primary hover:bg-gray-100 rounded-full transition-colors">
                <span class="material-icons">chevron_left</span>
              </button>
              <span id="month-year" class="mx-4">Maio 2025</span>
              <button id="next-month" class="p-2 text-primary hover:bg-gray-100 rounded-full transition-colors">
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>
          
          <!-- Calendar Grid -->
          <div class="grid grid-cols-7 gap-2 mb-6">
            <div class="text-center py-2 font-medium text-gray-500">Dom</div>
            <div class="text-center py-2 font-medium text-gray-500">Seg</div>
            <div class="text-center py-2 font-medium text-gray-500">Ter</div>
            <div class="text-center py-2 font-medium text-gray-500">Qua</div>
            <div class="text-center py-2 font-medium text-gray-500">Qui</div>
            <div class="text-center py-2 font-medium text-gray-500">Sex</div>
            <div class="text-center py-2 font-medium text-gray-500">Sáb</div>
            <!-- Calendar days will be inserted here by JavaScript -->
          </div>
          
          <!-- Legend -->
          <div class="flex flex-wrap gap-4 mb-6">
            <div class="flex items-center">
              <div class="w-4 h-4 rounded bg-success mr-2"></div>
              <span>Selecionado</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 rounded bg-warning mr-2"></div>
              <span>Pendente</span>
            </div>
            <div class="flex items-center">
              <div class="w-4 h-4 rounded bg-danger mr-2"></div>
              <span>Reservado</span>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex justify-end">
            <button id="reserve-btn" class="flex items-center bg-primary hover:bg-primary-light text-white font-medium py-2 px-4 rounded-lg transition-colors">
              <span class="material-icons mr-2">event_available</span>
              Reservar Datas
            </button>
          </div>
          
          <!-- Reservation Form Modal -->
          <div id="reservation-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
              <h3 class="text-xl font-bold mb-4">Formulário de Reserva</h3>
              
              <div class="space-y-4">
                <div>
                  <label for="client-name" class="block font-medium mb-1">Nome Completo</label>
                  <input type="text" id="client-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="Digite seu nome completo">
                </div>
                
                <div>
                  <label for="client-phone" class="block font-medium mb-1">Telefone</label>
                  <input type="tel" id="client-phone" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="(00) 00000-0000">
                </div>
                
                <div>
                  <label for="client-email" class="block font-medium mb-1">Email</label>
                  <input type="email" id="client-email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="seu@email.com">
                </div>
                
                <div>
                  <label class="block font-medium mb-1">Datas Selecionadas</label>
                  <div id="selected-dates-list" class="space-y-2 max-h-40 overflow-y-auto p-2 border rounded-lg"></div>
                </div>
              </div>
              
              <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-reservation" class="px-4 py-2 border border-primary text-primary rounded-lg hover:bg-gray-50 transition-colors">
                  Cancelar
                </button>
                <button id="confirm-reservation" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors">
                  Confirmar Reserva
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Admin Tab Content -->
        <div id="admin-tab" class="tab-content hidden p-6">
          <!-- Login Form -->
          <div id="login-form">
            <h3 class="text-xl font-bold mb-4">Acesso Administrativo</h3>
            
            <div class="space-y-4 max-w-md mx-auto">
              <div>
                <label for="admin-user" class="block font-medium mb-1">Usuário</label>
                <input type="text" id="admin-user" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="Nome de usuário">
              </div>
              
              <div>
                <label for="admin-pass" class="block font-medium mb-1">Senha</label>
                <input type="password" id="admin-pass" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-all" placeholder="Senha">
              </div>
              
              <button id="login-btn" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors">
                Entrar
              </button>
            </div>
          </div>
          
          <!-- Admin Panel -->
          <div id="admin-panel" class="hidden">
            <h3 class="text-xl font-bold mb-4">Gerenciar Reservas</h3>
            
            <!-- Admin Tabs -->
            <div class="flex border-b mb-4">
              <button data-tab="pending" class="tab-admin flex-1 py-3 px-6 text-center font-medium bg-gray-100 text-primary cursor-pointer transition-all">
                Pendentes
              </button>
              <button data-tab="confirmed" class="tab-admin flex-1 py-3 px-6 text-center font-medium bg-gray-100 text-gray-600 cursor-pointer transition-all">
                Confirmadas
              </button>
            </div>
            
            <!-- Pending Reservations -->
            <div id="pending-tab" class="tab-admin-content">
              <ul id="pending-list" class="space-y-3">
                <!-- Pending reservations will be inserted here -->
              </ul>
            </div>
            
            <!-- Confirmed Reservations -->
            <div id="confirmed-tab" class="tab-admin-content hidden">
              <ul id="confirmed-list" class="space-y-3">
                <!-- Confirmed reservations will be inserted here -->
              </ul>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white"></div>
  
  <!-- Loading Overlay -->
  <div id="loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin"></div>
  </div>
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://sdsvbkobrcmqlyxmrxxv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkc3Zia29icmNtcWx5eG1yeHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNTUxNjAsImV4cCI6MjA2MjkzMTE2MH0.ICXhQKN1UIzcnyD1XDU00gvd8K8YxqYrrjH5DubyFGc';
    
    // Initialize Supabase client with improved configuration
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true
      },
      realtime: {
        params: {
          eventsPerSecond: 10
        }
      },
      db: {
        schema: 'public'
      }
    });
    
    // App state
    let today = new Date();
    let selectedDates = [];
    let reservations = {};
    let currentUser = null;
    
    // DOM Elements
    const calendarEl = document.querySelector('.grid.grid-cols-7');
    const monthYearEl = document.getElementById('month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const reserveBtn = document.getElementById('reserve-btn');
    const reservationModal = document.getElementById('reservation-modal');
    const cancelReservationBtn = document.getElementById('cancel-reservation');
    const confirmReservationBtn = document.getElementById('confirm-reservation');
    const clientNameInput = document.getElementById('client-name');
    const clientPhoneInput = document.getElementById('client-phone');
    const clientEmailInput = document.getElementById('client-email');
    const selectedDatesList = document.getElementById('selected-dates-list');
    const loginBtn = document.getElementById('login-btn');
    const adminUserInput = document.getElementById('admin-user');
    const adminPassInput = document.getElementById('admin-pass');
    const adminPanel = document.getElementById('admin-panel');
    const loginForm = document.getElementById('login-form');
    const pendingList = document.getElementById('pending-list');
    const confirmedList = document.getElementById('confirmed-list');
    const loadingEl = document.getElementById('loading');
    const toastEl = document.getElementById('toast');
    const tabs = document.querySelectorAll('.tab');
    const adminTabs = document.querySelectorAll('.tab-admin');
    const adminTabContents = document.querySelectorAll('.tab-admin-content');
    
    // Utility functions
    function formatDateStr(date) {
      return date.toISOString().split('T')[0];
    }
    
    function formatDateBR(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    function showLoading() {
      loadingEl.classList.remove('hidden');
    }
    
    function hideLoading() {
      loadingEl.classList.add('hidden');
    }
    
    function showToast(message, type = 'success') {
      toastEl.textContent = message;
      toastEl.className = `toast fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white bg-${type} show`;
      
      setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3000);
    }
    
    // Improved error handling function
    async function handleSupabaseError(error, operation) {
      console.error(`Error during ${operation}:`, error);
      
      if (error.code === 'PGRST301') {
        showToast('Sua sessão expirou. Por favor, faça login novamente.', 'danger');
        currentUser = null;
        loginForm.classList.remove('hidden');
        adminPanel.classList.add('hidden');
      } else {
        showToast(`Erro ao ${operation}. ${error.message || 'Tente novamente.'}`, 'danger');
      }
    }
    
    // Improved setupRealtimeSubscription
    async function setupRealtimeSubscription() {
      try {
        // Remove any existing subscription
        await supabase.removeAllChannels();
        
        const channel = supabase
          .channel('reservas')
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'reservas'
          }, async (payload) => {
            console.log('Nova reserva:', payload);
            showToast('Nova reserva recebida!', 'success');
            await fetchReservations();
            await renderCalendar();
          })
          .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'reservas'
          }, async (payload) => {
            console.log('Reserva atualizada:', payload);
            showToast('Reserva atualizada!', 'success');
            await fetchReservations();
            await renderCalendar();
          })
          .on('postgres_changes', {
            event: 'DELETE',
            schema: 'public',
            table: 'reservas'
          }, async (payload) => {
            console.log('Reserva removida:', payload);
            showToast('Reserva removida!', 'success');
            await fetchReservations();
            await renderCalendar();
          });
        
        channel.subscribe(async (status) => {
          console.log('Status da inscrição:', status);
          if (status === 'SUBSCRIBED') {
            console.log('Conectado ao canal de tempo real');
            await fetchReservations();
            await renderCalendar();
          }
        });
      } catch (error) {
        console.error('Erro ao configurar sincronização em tempo real:', error);
        showToast('Erro ao configurar sincronização em tempo real', 'danger');
      }
    }
    
    // Calendar functions
    function initializeCalendar() {
      try {
        // Clear calendar days (but keep weekday headers)
        const dayElements = calendarEl.querySelectorAll('.calendar-day');
        dayElements.forEach(el => el.remove());
        
        // Set month and year display
        monthYearEl.textContent = today.toLocaleDateString('pt-BR', {
          month: 'long',
          year: 'numeric'
        }).replace(/^./, c => c.toUpperCase());
        
        // Get first and last day of month
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        // Add empty cells for days before start of month
        const startDayOfWeek = firstDay.getDay();
        for (let i = 0; i < startDayOfWeek; i++) {
          const emptyDay = document.createElement('div');
          emptyDay.className = 'calendar-day empty';
          calendarEl.appendChild(emptyDay);
        }
        
        // Add days of month
        for (let i = 1; i <= lastDay.getDate(); i++) {
          const date = new Date(today.getFullYear(), today.getMonth(), i);
          const dateStr = formatDateStr(date);
          
          const dayEl = document.createElement('div');
          dayEl.className = 'calendar-day aspect-square flex items-center justify-center rounded-lg border border-gray-200 cursor-pointer transition-colors';
          dayEl.textContent = i;
          dayEl.dataset.date = dateStr;
          
          // Check reservation status
          if (reservations[dateStr]) {
            const reservation = reservations[dateStr];
            
            if (reservation.status === 'confirmed') {
              dayEl.classList.add('bg-danger', 'text-white', 'border-danger', 'cursor-not-allowed');
              
              // Add tooltip with client name
              const tooltip = document.createElement('div');
              tooltip.className = 'tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 bg-dark text-white text-xs px-3 py-1 rounded-lg whitespace-nowrap';
              tooltip.textContent = `Reservado: ${reservation.client_name}`;
              dayEl.appendChild(tooltip);
            } else if (reservation.status === 'pending') {
              dayEl.classList.add('bg-warning', 'text-dark', 'border-warning');
              
              const tooltip = document.createElement('div');
              tooltip.className = 'tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 bg-dark text-white text-xs px-3 py-1 rounded-lg whitespace-nowrap';
              tooltip.textContent = 'Reserva pendente';
              dayEl.appendChild(tooltip);
            }
          } else {
            // Only allow selection of future dates
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            if (date >= currentDate) {
              dayEl.addEventListener('click', () => toggleDateSelection(dateStr));
              
              // Check if date is selected
              if (selectedDates.includes(dateStr)) {
                dayEl.classList.add('bg-success', 'text-white', 'border-success');
              } else {
                dayEl.classList.add('hover:bg-gray-100');
              }
            } else {
              dayEl.classList.add('bg-gray-100', 'cursor-not-allowed', 'text-gray-400');
            }
          }
          
          calendarEl.appendChild(dayEl);
        }
      } catch (error) {
        console.error('Erro ao renderizar calendário:', error);
        showToast('Erro ao exibir calendário', 'danger');
      }
    }
    
    // Initialize the application
    async function initializeApp() {
      try {
        showLoading();
        console.log('Iniciando aplicação...');
        
        // Initialize calendar
        today = new Date();
        selectedDates = [];
        reservations = {};
        
        // Fetch initial data
        await fetchReservations();
        
        // Initialize calendar UI
        initializeCalendar();
        
        // Setup realtime
        await setupRealtimeSubscription();
        
        // Initialize event listeners
        initializeEventListeners();
        
        console.log('Aplicação inicializada com sucesso');
      } catch (error) {
        console.error('Erro ao inicializar aplicação:', error);
        showToast('Erro ao inicializar aplicação', 'danger');
      } finally {
        hideLoading();
      }
    }
    
    function initializeEventListeners() {
      // Month navigation
      prevMonthBtn.addEventListener('click', () => {
        today.setMonth(today.getMonth() - 1);
        initializeCalendar();
      });
      
      nextMonthBtn.addEventListener('click', () => {
        today.setMonth(today.getMonth() + 1);
        initializeCalendar();
      });
      
      // Reservation buttons
      reserveBtn.addEventListener('click', showReservationModal);
      
      cancelReservationBtn.addEventListener('click', () => {
        reservationModal.classList.add('hidden');
      });
      
      confirmReservationBtn.addEventListener('click', submitReservation);
      
      // Admin login
      loginBtn.addEventListener('click', loginAdmin);
      
      // Main tabs navigation
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          const tabContent = document.getElementById(`${tabName}-tab`);
          
          // Deactivate all tabs
          tabs.forEach(t => t.classList.remove('bg-gray-100', 'text-primary'));
          tabs.forEach(t => t.classList.add('bg-gray-100', 'text-gray-600'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          
          // Activate selected tab
          tab.classList.remove('text-gray-600');
          tab.classList.add('bg-white', 'text-primary');
          tabContent.classList.remove('hidden');
        });
      });
      
      // Admin tabs navigation
      adminTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          const tabContent = document.getElementById(`${tabName}-tab`);
          
          // Deactivate all tabs
          adminTabs.forEach(t => t.classList.remove('bg-gray-100', 'text-primary'));
          adminTabs.forEach(t => t.classList.add('bg-gray-100', 'text-gray-600'));
          adminTabContents.forEach(c => c.classList.add('hidden'));
          
          // Activate selected tab
          tab.classList.remove('text-gray-600');
          tab.classList.add('bg-white', 'text-primary');
          tabContent.classList.remove('hidden');
        });
      });
    }
    
    // Enhanced fetchReservations
    async function fetchReservations() {
      try {
        console.log('Buscando reservas...');
        
        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .order('data', { ascending: true });
        
        if (error) {
          console.error('Erro ao buscar reservas:', error);
          throw error;
        }
        
        console.log('Dados recebidos:', data);
        
        // Convert array to object with date as key
        reservations = {};
        
        if (data && data.length > 0) {
          data.forEach(reservation => {
            reservations[reservation.data] = {
              id: reservation.id,
              date: reservation.data,
              client_name: reservation.nome_do_cliente,
              client_phone: reservation.telefone_do_cliente,
              client_email: reservation.e_mail,
              status: reservation.status,
              created_at: reservation.criado_em
            };
          });
          
          console.log('Reservas processadas:', reservations);
        } else {
          console.log('Nenhuma reserva encontrada');
        }
        
        return reservations;
      } catch (error) {
        console.error('Erro ao buscar reservas:', error);
        showToast('Erro ao carregar reservas: ' + (error.message || 'Erro desconhecido'), 'danger');
        return {};
      }
    }
    
    async function loginAdmin() {
      const username = adminUserInput.value.trim();
      const password = adminPassInput.value.trim();
      
      if (!username || !password) {
        showToast('Por favor, preencha todos os campos', 'danger');
        return;
      }
      
      showLoading();
      
      try {
        // In a real application, you would authenticate with Supabase Auth
        // For this demo, we'll use a simple check
        if (username === 'admin' && password === 'senha123') {
          currentUser = { role: 'admin' };
          loginForm.classList.add('hidden');
          adminPanel.classList.remove('hidden');
          await loadAdminData();
          showToast('Login realizado com sucesso!', 'success');
        } else {
          showToast('Usuário ou senha inválidos', 'danger');
        }
      } catch (error) {
        console.error('Login error:', error);
        showToast('Erro ao fazer login', 'danger');
      } finally {
        hideLoading();
        adminUserInput.value = '';
        adminPassInput.value = '';
      }
    }
    
    async function loadAdminData() {
      showLoading();
      
      try {
        // Fetch all reservations
        const { data, error } = await supabase
          .from('reservas')
          .select('*')
          .order('data', { ascending: true });
        
        if (error) throw error;
        
        // Clear lists
        pendingList.innerHTML = '';
        confirmedList.innerHTML = '';
        
        // Populate lists
        data.forEach(reservation => {
          const listItem = document.createElement('li');
          listItem.className = 'bg-gray-50 p-4 rounded-lg flex flex-col md:flex-row md:items-center justify-between gap-4';
          
          const dateInfo = document.createElement('div');
          dateInfo.className = 'flex-1';
          dateInfo.innerHTML = `
            <div class="font-medium">${formatDateBR(reservation.data)}</div>
            <div class="text-sm">${reservation.nome_do_cliente}</div>
            <div class="text-xs text-gray-500">${reservation.telefone_do_cliente}</div>
          `;
          
          const statusBadge = document.createElement('span');
          statusBadge.className = `inline-block px-3 py-1 rounded-full text-xs font-medium ${
            reservation.status === 'confirmed' ? 'bg-success text-white' : 'bg-warning text-dark'
          }`;
          statusBadge.textContent = reservation.status === 'confirmed' ? 'Confirmado' : 'Pendente';
          
          const actions = document.createElement('div');
          actions.className = 'flex gap-2';
          
          if (reservation.status === 'pending') {
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'px-3 py-1 bg-primary text-white rounded hover:bg-primary-light transition-colors text-sm';
            confirmBtn.textContent = 'Confirmar';
            confirmBtn.addEventListener('click', () => confirmReservation(reservation.id));
            
            const rejectBtn = document.createElement('button');
            rejectBtn.className = 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors text-sm';
            rejectBtn.textContent = 'Recusar';
            rejectBtn.addEventListener('click', () => deleteReservation(reservation.id));
            
            actions.appendChild(confirmBtn);
            actions.appendChild(rejectBtn);
            
            listItem.appendChild(dateInfo);
            listItem.appendChild(actions);
            pendingList.appendChild(listItem);
          } else {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-100 transition-colors text-sm';
            deleteBtn.textContent = 'Cancelar';
            deleteBtn.addEventListener('click', () => deleteReservation(reservation.id));
            
            actions.appendChild(deleteBtn);
            
            listItem.appendChild(dateInfo);
            listItem.appendChild(statusBadge);
            listItem.appendChild(actions);
            confirmedList.appendChild(listItem);
          }
        });
        
        // Show empty message if no reservations
        if (pendingList.children.length === 0) {
          pendingList.innerHTML = '<li class="text-center py-4 text-gray-500">Não há reservas pendentes.</li>';
        }
        
        if (confirmedList.children.length === 0) {
          confirmedList.innerHTML = '<li class="text-center py-4 text-gray-500">Não há reservas confirmadas.</li>';
        }
      } catch (error) {
        console.error('Error loading admin data:', error);
        showToast('Erro ao carregar dados', 'danger');
      } finally {
        hideLoading();
      }
    }
    
    async function confirmReservation(id) {
      showLoading();
      
      try {
        const { error } = await supabase
          .from('reservas')
          .update({ status: 'confirmed' })
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Reserva confirmada com sucesso!', 'success');
        await loadAdminData();
        await fetchReservations();
        initializeCalendar();
      } catch (error) {
        console.error('Error confirming reservation:', error);
        showToast('Erro ao confirmar reserva', 'danger');
      } finally {
        hideLoading();
      }
    }
    
    async function deleteReservation(id) {
      if (!confirm('Tem certeza que deseja cancelar esta reserva?')) return;
      
      showLoading();
      
      try {
        const { error } = await supabase
          .from('reservas')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Reserva cancelada com sucesso!', 'success');
        await loadAdminData();
        await fetchReservations();
        initializeCalendar();
      } catch (error) {
        console.error('Error deleting reservation:', error);
        showToast('Erro ao cancelar reserva', 'danger');
      } finally {
        hideLoading();
      }
    }
    
    function toggleDateSelection(dateStr) {
      const index = selectedDates.indexOf(dateStr);
      
      if (index >= 0) {
        // Remove date if already selected
        selectedDates.splice(index, 1);
      } else {
        // Add date to selection
        selectedDates.push(dateStr);
      }
      
      // Update calendar UI
      initializeCalendar();
      
      // Enable/disable reserve button
      reserveBtn.disabled = selectedDates.length === 0;
    }
    
    function showReservationModal() {
      if (selectedDates.length === 0) {
        showToast('Selecione pelo menos uma data', 'danger');
        return;
      }
      
      // Display selected dates
      selectedDatesList.innerHTML = '';
      selectedDates.sort().forEach(date => {
        const dateItem = document.createElement('div');
        dateItem.className = 'p-2 bg-gray-50 rounded text-center';
        dateItem.textContent = formatDateBR(date);
        selectedDatesList.appendChild(dateItem);
      });
      
      // Show modal
      reservationModal.classList.remove('hidden');
      clientNameInput.focus();
    }
    
    async function submitReservation() {
      // Enhanced validation
      const name = clientNameInput.value.trim();
      const phone = clientPhoneInput.value.trim();
      const email = clientEmailInput.value.trim();
      
      if (!name) {
        showToast('Por favor, informe seu nome', 'danger');
        clientNameInput.focus();
        return;
      }
      
      if (!phone) {
        showToast('Por favor, informe seu telefone', 'danger');
        clientPhoneInput.focus();
        return;
      }
      
      // Validate phone format
      const phoneRegex = /^\(\d{2}\)\s?\d{4,5}-\d{4}$/;
      if (!phoneRegex.test(phone)) {
        showToast('Formato de telefone inválido. Use (XX) XXXXX-XXXX', 'danger');
        clientPhoneInput.focus();
        return;
      }
      
      // Validate email if provided
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showToast('Formato de e-mail inválido', 'danger');
        clientEmailInput.focus();
        return;
      }
      
      showLoading();
      
      try {
        // Check for conflicting reservations first
        const { data: existingReservations, error: checkError } = await supabase
          .from('reservas')
          .select('data')
          .in('data', selectedDates)
          .eq('status', 'confirmed');
        
        if (checkError) throw checkError;
        
        if (existingReservations?.length > 0) {
          const conflictDates = existingReservations.map(r => formatDateBR(r.data)).join(', ');
          showToast(`As datas ${conflictDates} já estão reservadas`, 'danger');
          return;
        }
        
        // Create reservations for each selected date
        const reservationPromises = selectedDates.map(date => 
          supabase
            .from('reservas')
            .insert([{
              data: date,
              nome_do_cliente: name,
              telefone_do_cliente: phone,
              e_mail: email,
              status: 'pending',
              criado_em: new Date().toISOString()
            }])
        );
        
        const results = await Promise.all(reservationPromises);
        const errors = results.filter(r => r.error);
        
        if (errors.length > 0) {
          throw errors[0].error;
        }
        
        // Success - clear form and selected dates
        showToast('Reserva solicitada com sucesso!', 'success');
        reservationModal.classList.add('hidden');
        
        // Store info for WhatsApp message
        const datesToFormat = [...selectedDates];
        
        // Clear form and selection
        selectedDates = [];
        clientNameInput.value = '';
        clientPhoneInput.value = '';
        clientEmailInput.value = '';
        
        // Refresh calendar
        await fetchReservations();
        initializeCalendar();
        
        // Open WhatsApp with reservation details
        const formattedDates = datesToFormat.map(date => formatDateBR(date)).join(', ');
        const msg = `Olá! Eu, ${name}, gostaria de reservar o espaço Life Festas nas datas: ${formattedDates}. Telefone: ${phone}`;
        const url = `https://wa.me/5581981521109?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
      } catch (error) {
        await handleSupabaseError(error, 'criar reserva');
      } finally {
        hideLoading();
      }
    }
    
    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initializeApp().catch(error => {
        console.error('Erro fatal ao inicializar aplicação:', error);
        hideLoading();
        showToast('Erro ao carregar aplicação. Por favor, recarregue a página.', 'danger');
      });
    });
  </script>
</body>
</html>
