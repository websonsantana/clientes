<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reserva Espa칞o Life Festas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #004AAD;
      --primary-light: #3373d9;
      --secondary: #FF5722;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #F44336;
      --light: #F5F5F5;
      --dark: #212121;
      --gray: #757575;
    }
    body { font-family: 'Poppins', sans-serif; }
    h1, h2, h3, h4 { font-family: 'Montserrat', sans-serif; }
    .background {
      background-image: linear-gradient(135deg, rgba(0,74,173,0.9), rgba(0,74,173,0.7)), url('life.jpg');
    }
    .calendar-day:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .toast {
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--light);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      font-size: 0.9rem;
    }
    .calendar-day.past { background-color: var(--light); color: var(--gray); cursor: not-allowed; }
    .calendar-day.reserved { background-color: var(--danger); color: white; border-color: var(--danger); cursor: not-allowed; }
    .calendar-day.pending { background-color: var(--warning); color: var(--dark); border-color: var(--warning); }
    .calendar-day.selected { background-color: var(--success); color: white; border-color: var(--success); }
    .calendar-day.empty { border: none; cursor: default; }
  </style>
</head>
<body class="min-h-screen bg-gray-50">
  <!-- Background -->
  <div class="background fixed inset-0 -z-10 bg-cover bg-center"></div>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <img src="life.png" alt="Logo Life Festas" class="mx-auto h-28 mb-4 drop-shadow-lg">
      <h1 class="text-4xl font-bold text-white mb-2 drop-shadow-md">Reserva Espa칞o Life Festas</h1>
      <p class="text-lg text-white/90 font-light">Escolha as datas para seu evento especial</p>
    </header>

    <!-- Card Container -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden max-w-4xl mx-auto">
      <!-- Tabs -->
      <div class="flex border-b">
        <button data-tab="calendar" class="tab flex-1 py-4 px-6 text-center font-medium bg-gray-100 text-primary">Calend치rio</button>
        <button data-tab="admin" class="tab flex-1 py-4 px-6 text-center font-medium bg-gray-100 text-gray-600">Administrador</button>
      </div>

      <!-- Calendar Content -->
      <div id="calendar-tab" class="tab-content p-6">
        <div class="month-selector flex items-center justify-center gap-4 mb-4">
          <button id="prev-month" class="month-arrow" type="button"><span class="material-icons">chevron_left</span></button>
          <span id="month-year" class="font-medium text-lg"></span>
          <button id="next-month" class="month-arrow" type="button"><span class="material-icons">chevron_right</span></button>
        </div>

        <div class="grid grid-cols-7 gap-2 mb-4">
          <div class="text-center font-medium text-gray-500">Dom</div>
          <div class="text-center font-medium text-gray-500">Seg</div>
          <div class="text-center font-medium text-gray-500">Ter</div>
          <div class="text-center font-medium text-gray-500">Qua</div>
          <div class="text-center font-medium text-gray-500">Qui</div>
          <div class="text-center font-medium text-gray-500">Sex</div>
          <div class="text-center font-medium text-gray-500">S치b</div>
        </div>

        <!-- Dias do calend치rio s칚o inseridos via JS -->

        <div class="flex flex-wrap gap-4 mb-6">
          <div class="flex items-center"><div class="w-4 h-4 bg-success mr-2 rounded"></div><span>Selecionado</span></div>
          <div class="flex items-center"><div class="w-4 h-4 bg-warning mr-2 rounded"></div><span>Pendente</span></div>
          <div class="flex items-center"><div class="w-4 h-4 bg-danger mr-2 rounded"></div><span>Reservado</span></div>
        </div>

        <div class="flex justify-end">
          <button id="reserve-btn" class="btn btn-primary" disabled>
            <span class="material-icons">event_available</span>
            Reservar Datas
          </button>
        </div>
      </div>

      <!-- Modal de Reserva -->
      <div id="reservation-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
          <h3 class="text-xl font-bold mb-4">Formul치rio de Reserva</h3>
          <div class="space-y-4">
            <div>
              <label for="client-name" class="block font-medium mb-1">Nome Completo</label>
              <input type="text" id="client-name" class="w-full border rounded-lg px-4 py-2" />
            </div>
            <div>
              <label for="client-phone" class="block font-medium mb-1">Telefone</label>
              <input type="tel" id="client-phone" class="w-full border rounded-lg px-4 py-2" />
            </div>
            <div>
              <label for="client-email" class="block font-medium mb-1">Email</label>
              <input type="email" id="client-email" class="w-full border rounded-lg px-4 py-2" />
            </div>
            <div>
              <label class="block font-medium mb-1">Datas Selecionadas</label>
              <div id="selected-dates-list" class="p-2 border rounded-lg max-h-40 overflow-y-auto space-y-2"></div>
            </div>
          </div>
          <div class="flex justify-end gap-2 mt-6">
            <button id="cancel-reservation" class="btn btn-outline">Cancelar</button>
            <button id="confirm-reservation" class="btn btn-primary">Confirmar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white"></div>

  <!-- Loading -->
  <div id="loading" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin"></div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
<script>
  // Configura칞칚o do Supabase
  const SUPABASE_URL = 'https://sdsvbkobrcmqlyxmrxxv.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkc3Zia29icmNtcWx5eG1yeHh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNTUxNjAsImV4cCI6MjA2MjkzMTE2MH0.ICXhQKN1UIzcnyD1XDU00gvd8K8YxqYrrjH5DubyFGc'; // mantenha sua chave segura
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Estado da aplica칞칚o
  let today = new Date();
  let selectedDates = [];
  let reservations = {};
  let currentUser = null;

  // Elementos DOM
  const calendarEl = document.querySelector('.grid.grid-cols-7');
  const monthYearEl = document.getElementById('month-year');
  const prevMonthBtn = document.getElementById('prev-month');
  const nextMonthBtn = document.getElementById('next-month');
  const reserveBtn = document.getElementById('reserve-btn');
  const reservationModal = document.getElementById('reservation-modal');
  const cancelReservationBtn = document.getElementById('cancel-reservation');
  const confirmReservationBtn = document.getElementById('confirm-reservation');
  const clientNameInput = document.getElementById('client-name');
  const clientPhoneInput = document.getElementById('client-phone');
  const clientEmailInput = document.getElementById('client-email');
  const selectedDatesList = document.getElementById('selected-dates-list');
  const loadingEl = document.getElementById('loading');
  const toastEl = document.getElementById('toast');

  // Utilit치rios
  function formatDateStr(date) {
    return date.toISOString().split('T')[0];
  }

  function formatDateBR(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
  }

  function showLoading() {
    loadingEl.classList.remove('hidden');
  }

  function hideLoading() {
    loadingEl.classList.add('hidden');
  }

  function showToast(message, type = 'success') {
    toastEl.textContent = message;
    toastEl.className = `toast fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white bg-${type} show`;
    setTimeout(() => toastEl.classList.remove('show'), 3000);
  }

  const initializeCalendar = renderCalendar; // 游댢 Corre칞칚o do erro: fun칞칚o definida aqui

  async function fetchReservations() {
    try {
      const { data, error } = await supabase
        .from('reservas')
        .select('id, data, nome_do_cliente, telefone_do_cliente, e_mail, status, criado_em')
        .order('data', { ascending: true });

      if (error) throw error;

      reservations = {};
      data.forEach(reservation => {
        reservations[reservation.data] = {
          id: reservation.id,
          date: reservation.data,
          client_name: reservation.nome_do_cliente,
          client_phone: reservation.telefone_do_cliente,
          client_email: reservation.e_mail,
          status: reservation.status,
          created_at: reservation.criado_em
        };
      });
    } catch (error) {
      console.error('Erro ao buscar reservas:', error);
      showToast('Erro ao carregar reservas', 'danger');
    }
  }
  async function renderCalendar() {
    calendarEl.innerHTML = '';

    const monthYear = today.toLocaleDateString('pt-BR', {
      month: 'long',
      year: 'numeric'
    });
    monthYearEl.textContent = monthYear.charAt(0).toUpperCase() + monthYear.slice(1);

    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

    const startDayOfWeek = firstDay.getDay();
    for (let i = 0; i < startDayOfWeek; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day empty';
      calendarEl.appendChild(emptyDay);
    }

    for (let i = 1; i <= lastDay.getDate(); i++) {
      const date = new Date(today.getFullYear(), today.getMonth(), i);
      const dateStr = formatDateStr(date);
      const dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      dayEl.textContent = i;
      dayEl.dataset.date = dateStr;

      const currentDate = new Date();
      currentDate.setHours(0, 0, 0, 0);

      if (date < currentDate) {
        dayEl.classList.add('past');
        dayEl.title = 'Data passada';
      } else {
        if (reservations[dateStr]) {
          const r = reservations[dateStr];
          if (r.status === 'confirmed') {
            dayEl.classList.add('reserved');
            dayEl.title = `Reservado: ${r.client_name}`;
          } else if (r.status === 'pending') {
            dayEl.classList.add('pending');
            dayEl.title = 'Reserva pendente';
          }
        } else {
          dayEl.addEventListener('click', () => toggleDateSelection(dateStr));
          if (selectedDates.includes(dateStr)) {
            dayEl.classList.add('selected');
          }
          dayEl.title = 'Clique para selecionar';
        }
      }

      calendarEl.appendChild(dayEl);
    }

    reserveBtn.disabled = selectedDates.length === 0;
  }

  function toggleDateSelection(dateStr) {
    const index = selectedDates.indexOf(dateStr);
    if (index >= 0) {
      selectedDates.splice(index, 1);
    } else {
      selectedDates.push(dateStr);
    }
    initializeCalendar();
    reserveBtn.disabled = selectedDates.length === 0;
  }

  function showReservationModal() {
    if (selectedDates.length === 0) {
      showToast('Selecione pelo menos uma data', 'danger');
      return;
    }

    selectedDatesList.innerHTML = '';
    selectedDates.sort().forEach(date => {
      const div = document.createElement('div');
      div.className = 'p-2 bg-gray-50 rounded text-center';
      div.textContent = formatDateBR(date);
      selectedDatesList.appendChild(div);
    });

    reservationModal.classList.remove('hidden');
    clientNameInput.focus();
  }

  async function submitReservation() {
    const name = clientNameInput.value.trim();
    const phone = clientPhoneInput.value.trim();
    const email = clientEmailInput.value.trim();

    if (!name) {
      showToast('Informe seu nome', 'danger');
      clientNameInput.focus();
      return;
    }

    if (!phone.match(/^(\(?\d{2}\)?\s?)?\d{4,5}-?\d{4}$/)) {
      showToast('Telefone inv치lido', 'danger');
      clientPhoneInput.focus();
      return;
    }

    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      showToast('E-mail inv치lido', 'danger');
      clientEmailInput.focus();
      return;
    }

    showLoading();

    try {
      const { data: conflicts, error } = await supabase
        .from('reservas')
        .select('data')
        .in('data', selectedDates)
        .eq('status', 'confirmed');

      if (error) throw error;
      if (conflicts?.length > 0) {
        showToast(`Datas j치 reservadas: ${conflicts.map(r => formatDateBR(r.data)).join(', ')}`, 'danger');
        return;
      }

      const inserts = selectedDates.map(date => ({
        data: date,
        nome_do_cliente: name,
        telefone_do_cliente: phone,
        e_mail: email,
        status: 'pending',
        criado_em: new Date().toISOString()
      }));

      const { error: insertError } = await supabase.from('reservas').insert(inserts);
      if (insertError) throw insertError;

      showToast('Reserva enviada com sucesso!', 'success');
      reservationModal.classList.add('hidden');
      selectedDates = [];
      clientNameInput.value = '';
      clientPhoneInput.value = '';
      clientEmailInput.value = '';
      await fetchReservations();
      initializeCalendar();

      const msg = `Ol치! Eu, ${name}, gostaria de reservar o espa칞o Life Festas nas datas: ${inserts.map(r => formatDateBR(r.data)).join(', ')}. Telefone: ${phone}`;
      const url = `https://wa.me/5581981521109?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
    } catch (error) {
      console.error(error);
      showToast('Erro ao enviar reserva', 'danger');
    } finally {
      hideLoading();
    }
  }
</script>
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      showLoading();

      // Navega칞칚o entre abas
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.tab;
          document.querySelectorAll('.tab').forEach(t => {
            t.classList.remove('bg-white', 'text-primary');
            t.classList.add('bg-gray-100', 'text-gray-600');
          });
          tab.classList.add('bg-white', 'text-primary');

          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById(`${target}-tab`).classList.remove('hidden');
        });
      });

      // Eventos de navega칞칚o do calend치rio
      prevMonthBtn.addEventListener('click', () => {
        today.setMonth(today.getMonth() - 1);
        initializeCalendar();
      });

      nextMonthBtn.addEventListener('click', () => {
        today.setMonth(today.getMonth() + 1);
        initializeCalendar();
      });

      // Eventos dos bot칫es do modal
      reserveBtn.addEventListener('click', showReservationModal);
      cancelReservationBtn.addEventListener('click', () => {
        reservationModal.classList.add('hidden');
        selectedDates = [];
        initializeCalendar();
      });

      confirmReservationBtn.addEventListener('click', submitReservation);

      // Carrega dados e renderiza o calend치rio
      await fetchReservations();
      initializeCalendar();

      showToast('Sistema carregado com sucesso!');
    } catch (error) {
      console.error('Erro ao iniciar o sistema:', error);
      showToast('Erro ao iniciar o sistema', 'danger');
    } finally {
      hideLoading();
    }
  });
</script>

</body>
</html>
