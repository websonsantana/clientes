<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Controle Financeiro 50-30-20</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-700 mb-2">Meu Controle Financeiro</h1>
            <p class="text-gray-600">Sistema baseado na regra 50-30-20 para gerenciar suas finanças pessoais</p>
        </header>

        <!-- Dashboard Summary -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                <h3 class="text-gray-500 font-medium">Saldo Atual</h3>
                <p class="text-2xl font-bold" id="currentBalance">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                <h3 class="text-gray-500 font-medium">Receitas</h3>
                <p class="text-2xl font-bold" id="totalIncome">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                <h3 class="text-gray-500 font-medium">Despesas</h3>
                <p class="text-2xl font-bold" id="totalExpenses">R$ 0,00</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
                <h3 class="text-gray-500 font-medium">Economias</h3>
                <p class="text-2xl font-bold" id="totalSavings">R$ 0,00</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Income Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-money-bill-wave text-green-500 mr-2"></i> Receitas
                </h2>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Salário</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                        <input type="number" id="salaryInput" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Outras Receitas</label>
                    <div class="flex space-x-2 mb-2">
                        <input type="text" id="otherIncomeDesc" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Descrição">
                        <div class="relative w-32">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                            <input type="number" id="otherIncomeValue" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                        </div>
                        <button id="addIncomeBtn" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <ul id="incomeList" class="divide-y">
                        <!-- Income items will be added here -->
                    </ul>
                </div>
                <div class="mt-6 bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-2">Distribuição 50-30-20</h3>
                    <ul class="text-sm text-blue-700">
                        <li class="flex justify-between"><span>Necessidades (50%):</span> <span id="needsAmount">R$ 0,00</span></li>
                        <li class="flex justify-between"><span>Desejos (30%):</span> <span id="wantsAmount">R$ 0,00</span></li>
                        <li class="flex justify-between"><span>Economias (20%):</span> <span id="savingsAmount">R$ 0,00</span></li>
                    </ul>
                </div>
            </div>

            <!-- Expenses Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-credit-card text-red-500 mr-2"></i> Despesas
                </h2>
                
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">Custos Fixos</h3>
                    <div class="flex space-x-2 mb-2">
                        <select id="fixedExpenseType" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Selecione um tipo</option>
                            <option value="Moradia">Moradia</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Alimentação">Alimentação</option>
                            <option value="Educação">Educação</option>
                            <option value="Saúde">Saúde</option>
                            <option value="Outros">Outros</option>
                        </select>
                        <div class="relative w-32">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                            <input type="number" id="fixedExpenseValue" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                        </div>
                        <button id="addFixedExpenseBtn" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <ul id="fixedExpensesList" class="divide-y">
                        <!-- Fixed expenses will be added here -->
                    </ul>
                </div>

                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-2">Custos Variáveis</h3>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <select id="variableCategory" class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                        <input type="text" id="variableExpenseDesc" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Descrição">
                        <div class="relative w-32">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                            <input type="number" id="variableExpenseValue" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                        </div>
                        <button id="addVariableExpenseBtn" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <ul id="variableExpensesList" class="divide-y">
                        <!-- Variable expenses will be added here -->
                    </ul>
                </div>

                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Gastos Não Previstos</h3>
                    <div class="flex space-x-2 mb-2">
                        <input type="text" id="unexpectedExpenseDesc" class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Descrição">
                        <div class="relative w-32">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                            <input type="number" id="unexpectedExpenseValue" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                        </div>
                        <button id="addUnexpectedExpenseBtn" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <ul id="unexpectedExpensesList" class="divide-y">
                        <!-- Unexpected expenses will be added here -->
                    </ul>
                </div>
            </div>

            <!-- Stats & Charts -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i> Análise
                </h2>

                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">Distribuição de Gastos</h3>
                    <div class="chart-container">
                        <svg id="expenseChart" width="100%" height="100%" viewBox="0 0 200 200">
                            <path id="needsArc" class="progress-ring__circle" stroke="url(#needsGradient)" stroke-width="30" fill="transparent" stroke-dasharray="0 1000"/>
                            <path id="wantsArc" class="progress-ring__circle" stroke="url(#wantsGradient)" stroke-width="30" fill="transparent" stroke-dasharray="0 1000" transform="rotate(0)"/>
                            <path id="savingsArc" class="progress-ring__circle" stroke="url(#savingsGradient)" stroke-width="30" fill="transparent" stroke-dasharray="0 1000" transform="rotate(0)"/>
                            
                            <defs>
                                <linearGradient id="needsGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#3B82F6" />
                                    <stop offset="100%" stop-color="#1D4ED8" />
                                </linearGradient>
                                <linearGradient id="wantsGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#EC4899" />
                                    <stop offset="100%" stop-color="#BE185D" />
                                </linearGradient>
                                <linearGradient id="savingsGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#10B981" />
                                    <stop offset="100%" stop-color="#047857" />
                                </linearGradient>
                            </defs>
                            
                            <text x="50%" y="50%" text-anchor="middle" dy="0" class="text-lg font-bold fill-gray-700">50-30-20</text>
                            <text x="50%" y="50%" text-anchor="middle" dy="20" class="text-xs fill-gray-500">Regra Financeira</text>
                        </svg>
                    </div>
                </div>

                <div class="mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Resumo por Categoria</h3>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                            <span class="flex-1 text-sm">Necessidades (50%)</span>
                            <span id="needsPercentage" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-pink-500 rounded-full mr-2"></div>
                            <span class="flex-1 text-sm">Desejos (30%)</span>
                            <span id="wantsPercentage" class="text-sm font-medium">0%</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                            <span class="flex-1 text-sm">Economias (20%)</span>
                            <span id="savingsPercentage" class="text-sm font-medium">0%</span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-medium text-yellow-800 mb-2">Status Financeiro</h3>
                    <p class="text-sm text-yellow-700" id="financialStatus">Adicione suas receitas e despesas para ver o status.</p>
                </div>
                <canvas id="expensePie" class="w-full max-w-xs mx-auto"></canvas>
                <canvas id="lineMeses" class="w-full max-w-xl mx-auto mt-6"></canvas>
            </div>
        </div>

        <!-- Bills to Pay -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-file-invoice-dollar text-orange-500 mr-2"></i> Contas a Pagar
            </h2>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-4">
                <div class="flex-1">
                    <label class="block text-gray-700 mb-2">Descrição</label>
                    <input type="text" id="billDesc" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Luz, Água, Internet">
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 mb-2">Valor</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-600">R$</span>
                        <input type="number" id="billValue" class="w-full pl-8 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0,00">
                    </div>
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 mb-2">Data de Vencimento</label>
                    <input type="date" id="billDueDate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex items-end">
                    <button id="addBillBtn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">
                        Adicionar Conta
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 text-sm">
                            <th class="px-4 py-2 text-left">Descrição</th>
                            <th class="px-4 py-2 text-right">Valor</th>
                            <th class="px-4 py-2 text-left">Vencimento</th>
                            <th class="px-4 py-2 text-center">Status</th>
                            <th class="px-4 py-2 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="billsTable" class="divide-y">
                        <!-- Bill items will be added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Local Storage Controls -->
        <div class="bg-gray-100 rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Salvar Dados</h2>
            <div class="flex flex-wrap gap-4">
                <button id="saveDataBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center">
                    <i class="fas fa-save mr-2"></i> Salvar no Navegador
                </button>
                <button id="loadDataBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition flex items-center">
                    <i class="fas fa-folder-open mr-2"></i> Carregar Dados
                </button>
                <button id="clearDataBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i> Limpar Tudo
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Supabase client & auth check ---
const supabase = window.supabase.createClient(
  'https://pzxixywhuhofeiipwiro.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6eGl4eXdodWhvZmVpaXB3aXJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NTcxMTQsImV4cCI6MjA2NTIzMzExNH0._EdPnaZ_wOw1q4VQjHJApEjMnaz9l6MdRy1S9mkYR1I'
);
supabase.auth.getUser().then(({data})=>{
  if (!data.user) window.location='login.html';
});
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const salaryInput = document.getElementById('salaryInput');
            const otherIncomeDesc = document.getElementById('otherIncomeDesc');
            const otherIncomeValue = document.getElementById('otherIncomeValue');
            const addIncomeBtn = document.getElementById('addIncomeBtn');
            const incomeList = document.getElementById('incomeList');
            
            const fixedExpenseType = document.getElementById('fixedExpenseType');
            const fixedExpenseValue = document.getElementById('fixedExpenseValue');
            const addFixedExpenseBtn = document.getElementById('addFixedExpenseBtn');
            const fixedExpensesList = document.getElementById('fixedExpensesList');
            
            const variableCategory = document.getElementById('variableCategory');
            const variableExpenseDesc = document.getElementById('variableExpenseDesc');
            const variableExpenseValue = document.getElementById('variableExpenseValue');
            const addVariableExpenseBtn = document.getElementById('addVariableExpenseBtn');
            const variableExpensesList = document.getElementById('variableExpensesList');
            
            const unexpectedExpenseDesc = document.getElementById('unexpectedExpenseDesc');
            const unexpectedExpenseValue = document.getElementById('unexpectedExpenseValue');
            const addUnexpectedExpenseBtn = document.getElementById('addUnexpectedExpenseBtn');
            const unexpectedExpensesList = document.getElementById('unexpectedExpensesList');
            
            const billDesc = document.getElementById('billDesc');
            const billValue = document.getElementById('billValue');
            const billDueDate = document.getElementById('billDueDate');
            const addBillBtn = document.getElementById('addBillBtn');
            const billsTable = document.getElementById('billsTable');
            
            const saveDataBtn = document.getElementById('saveDataBtn');
            const loadDataBtn = document.getElementById('loadDataBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            
            const currentBalance = document.getElementById('currentBalance');
            const totalIncome = document.getElementById('totalIncome');
            const totalExpenses = document.getElementById('totalExpenses');
            const totalSavings = document.getElementById('totalSavings');
            
            const needsAmount = document.getElementById('needsAmount');
            const wantsAmount = document.getElementById('wantsAmount');
            const savingsAmount = document.getElementById('savingsAmount');
            
            const needsPercentage = document.getElementById('needsPercentage');
            const wantsPercentage = document.getElementById('wantsPercentage');
            const savingsPercentage = document.getElementById('savingsPercentage');
            
            // Mapa categoria para despesas fixas
const categoriaMap = {
  'Moradia':'necessidade','Transporte':'necessidade','Alimentação':'necessidade',
  'Educação':'necessidade','Saúde':'necessidade','Outros':'desejo'
};

// ---------- Funções CRUD Supabase ----------
async function addIncome(){
  const desc = otherIncomeDesc.value.trim();
  const val  = parseFloat(otherIncomeValue.value);
  if(!desc||isNaN(val)||val<=0){alert('Preencha descrição e valor');return;}
  const {data:{user}} = await supabase.auth.getUser();
  const {error} = await supabase.from('receitas').insert({usuario_id:user.id,descricao:desc,valor:val});
  if(error){alert(error.message);return;}
  otherIncomeDesc.value=''; otherIncomeValue.value='';
  await renderIncomeList(); await updateDashboard();
}

async function renderIncomeList(){
  const {data:{user}} = await supabase.auth.getUser();
  const {data:receitas,error} = await supabase.from('receitas').select('*').eq('usuario_id',user.id).order('data',{ascending:false});
  if(error){console.error(error);return;}
  incomeList.innerHTML = (receitas||[]).map(r=>`<li class="py-2 flex justify-between items-center fade-in"><div><span class="font-medium">${r.descricao}</span><span class="text-sm text-gray-500 ml-2">${formatCurrency(r.valor)}</span></div><button onclick=\"deleteIncome('${r.id}')\" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></li>`).join('');
}

async function deleteIncome(id){
  if(!confirm('Excluir receita?'))return;
  const {error}=await supabase.from('receitas').delete().eq('id',id);
  if(error){alert(error.message);return;}
  await renderIncomeList(); await updateDashboard();
}

async function addFixedExpense(){
  const type=fixedExpenseType.value; const val=parseFloat(fixedExpenseValue.value);
  if(!type||isNaN(val)||val<=0){alert('Tipo/valor inválido');return;}
  const cat=categoriaMap[type]||'necessidade';
  const {data:{user}} = await supabase.auth.getUser();
  const {error}=await supabase.from('despesas').insert({usuario_id:user.id,descricao:type,valor:val,categoria:cat});
  if(error){alert(error.message);return;}
  fixedExpenseType.value=''; fixedExpenseValue.value='';
  await renderFixedExpensesList(); await updateDashboard();
}

async function renderFixedExpensesList(){
  const {data:{user}} = await supabase.auth.getUser();
  const {data:despesas}=await supabase.from('despesas').select('*').eq('usuario_id',user.id).eq('categoria','necessidade').order('data',{ascending:false});
  fixedExpensesList.innerHTML = (despesas||[]).map(d=>`<li class="py-2 flex justify-between items-center fade-in"><div><span class="font-medium">${d.descricao}</span><span class="text-sm text-gray-500 ml-2">${formatCurrency(d.valor)}</span></div><button onclick=\"deleteFixedExpense('${d.id}')\" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></li>`).join('');
}

async function deleteFixedExpense(id){
  if(!confirm('Excluir despesa?'))return;
  const {error}=await supabase.from('despesas').delete().eq('id',id);
  if(error){alert(error.message);return;}
  await renderFixedExpensesList(); await updateDashboard();
}

async function addVariableExpense(){
  const desc=variableExpenseDesc.value.trim(); const val=parseFloat(variableExpenseValue.value);
  const catId=variableCategory.value;
  if(catId==='new'){alert('Escolha ou crie uma categoria');return;}
  if(!desc||isNaN(val)||val<=0){alert('Descrição/valor inválido');return;}
  const {data:{user}}=await supabase.auth.getUser();
  const {error}=await supabase.from('despesas').insert({usuario_id:user.id,descricao:desc,valor:val,categoria:'desejo',categoria_id:catId});
  if(error){alert(error.message);return;}
  variableExpenseDesc.value=''; variableExpenseValue.value='';
  variableCategory.selectedIndex=0;
  await renderVariableExpensesList(); await updateDashboard();
}

async function renderVariableExpensesList(){
  const {data:{user}} = await supabase.auth.getUser();
  const {data:despesas}=await supabase.from('despesas').select('*,categorias(nome)').eq('usuario_id',user.id).eq('categoria','desejo').order('data',{ascending:false});
  variableExpensesList.innerHTML = (despesas||[]).map(d=>`<li class="py-2 flex justify-between items-center fade-in"><div><span class="font-medium">${d.categorias?d.categorias.nome:''} - ${d.descricao}</span><span class="text-sm text-gray-500 ml-2">${formatCurrency(d.valor)}</span></div><button onclick=\"deleteVariableExpense('${d.id}')\" class="text-red-500 hover:text-red-700"><i class='fas fa-trash'></i></button></li>`).join('');
}

async function deleteVariableExpense(id){
  if(!confirm('Excluir despesa?'))return;
  const {error}=await supabase.from('despesas').delete().eq('id',id);
  if(error){alert(error.message);return;}
  await renderVariableExpensesList(); await updateDashboard();
}

async function addUnexpectedExpense(){
  const desc=unexpectedExpenseDesc.value.trim(); const val=parseFloat(unexpectedExpenseValue.value);
  if(!desc||isNaN(val)||val<=0){alert('Descrição/valor inválido');return;}
  const {data:{user}}=await supabase.auth.getUser();
  const {error}=await supabase.from('despesas').insert({usuario_id:user.id,descricao:desc,valor:val,categoria:'imprevisto'});
  if(error){alert(error.message);return;}
  unexpectedExpenseDesc.value=''; unexpectedExpenseValue.value='';
  await renderUnexpectedExpensesList(); await updateDashboard();
}

async function renderUnexpectedExpensesList(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data:despesas}=await supabase.from('despesas').select('*').eq('usuario_id',user.id).eq('categoria','imprevisto').order('data',{ascending:false});
  unexpectedExpensesList.innerHTML=(despesas||[]).map(d=>`<li class="py-2 flex justify-between items-center fade-in"><div><span class="font-medium">${d.descricao}</span><span class="text-sm text-gray-500 ml-2">${formatCurrency(d.valor)}</span></div><button onclick=\"deleteUnexpectedExpense('${d.id}')\" class="text-red-500 hover:text-red-700"><i class='fas fa-trash'></i></button></li>`).join('');
}

async function deleteUnexpectedExpense(id){
  if(!confirm('Excluir gasto?'))return;
  const {error}=await supabase.from('despesas').delete().eq('id',id);
  if(error){alert(error.message);return;}
  await renderUnexpectedExpensesList(); await updateDashboard();
}

async function addBill(){
  const desc=billDesc.value.trim();
  const val=parseFloat(billValue.value);
  const due=billDueDate.value;
  if(!desc||isNaN(val)||val<=0||!due){alert('Preencha todos os campos');return;}
  const {data:{user}}=await supabase.auth.getUser();
  const {error}=await supabase.from('contas').insert({usuario_id:user.id,descricao:desc,valor:val,data_venc:due,pago:false});
  if(error){alert(error.message);return;}
  billDesc.value='';billValue.value='';billDueDate.value='';
  await renderBillsTable();await updateDashboard();
}

async function renderBillsTable(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data:bills,error}=await supabase.from('contas').select('*').eq('usuario_id',user.id).order('data_venc');
  if(error){console.error(error);return;}
  billsTable.innerHTML=(bills||[]).map(b=>`<tr><td class="px-4 py-2">${b.descricao}</td><td class="px-4 py-2 text-right">${formatCurrency(b.valor)}</td><td class="px-4 py-2">${new Date(b.data_venc).toLocaleDateString('pt-BR')}</td><td class="px-4 py-2 text-center"><span class="px-2 py-1 rounded-full text-xs ${b.pago?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}">${b.pago?'Pago':'Pendente'}</span></td><td class="px-4 py-2 text-right"><button onclick="toggleBillStatus('${b.id}',${b.pago})" class="text-blue-500 mr-2">${b.pago?'<i class=\"fas fa-undo\"></i>':'<i class=\"fas fa-check\"></i>'}</button><button onclick="deleteBill('${b.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`).join('');
}

async function toggleBillStatus(id,pago){
  const {error}=await supabase.from('contas').update({pago:!pago}).eq('id',id);
  if(error){alert(error.message);return;}
  await renderBillsTable();await updateDashboard();
}

async function deleteBill(id){
  const {error}=await supabase.from('contas').delete().eq('id',id);
  if(error){alert(error.message);return;}
  await renderBillsTable();await updateDashboard();
}

async function updateDashboard(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data:receitas}=await supabase.from('receitas').select('valor').eq('usuario_id',user.id);
  const {data:despesas}=await supabase.from('despesas').select('valor,categoria').eq('usuario_id',user.id);
  const {data:bills}=await supabase.from('contas').select('valor,pago').eq('usuario_id',user.id);
  const totalReceitas=receitas.reduce((s,r)=>s+r.valor,0);
  const totalNecess=despesas.filter(d=>d.categoria==='necessidade').reduce((s,d)=>s+d.valor,0);
  const totalDesejos=despesas.filter(d=>d.categoria==='desejo').reduce((s,d)=>s+d.valor,0);
  const totalImprev=despesas.filter(d=>d.categoria==='imprevisto').reduce((s,d)=>s+d.valor,0);
  const unpaidBills=(bills||[]).filter(b=>!b.pago).reduce((s,b)=>s+b.valor,0);
  const totalDespesas=totalNecess+totalDesejos+totalImprev+unpaidBills;
  const saldo=totalReceitas-totalDespesas;
  currentBalance.textContent=formatCurrency(saldo);
  totalIncome.textContent=formatCurrency(totalReceitas);
  totalExpenses.textContent=formatCurrency(totalDespesas);
  totalSavings.textContent=formatCurrency(Math.max(saldo,0));
  needsAmount.textContent=formatCurrency(totalNecess);
  wantsAmount.textContent=formatCurrency(totalDesejos);
  savingsAmount.textContent=formatCurrency(Math.max(saldo,0));
  const percNec=totalReceitas?((totalNecess/totalReceitas)*100).toFixed(0):0;
  const percDes=totalReceitas?((totalDesejos/totalReceitas)*100).toFixed(0):0;
  needsPercentage.textContent=percNec+'%';
  wantsPercentage.textContent=percDes+'%';
  savingsPercentage.textContent=(100-percNec-percDes)+'%';
  updateChart();
  renderMonthlyLine();
}

// ---- utilidades ----
function formatCurrency(value){
  return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(value||0);
}

let pie;
async function updateChart(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data:receitas}=await supabase.from('receitas').select('valor').eq('usuario_id',user.id);
  const {data:despesas}=await supabase.from('despesas').select('valor,categoria').eq('usuario_id',user.id);
  const {data:bills}=await supabase.from('contas').select('valor,pago').eq('usuario_id',user.id);
  const totalReceitas=receitas.reduce((s,r)=>s+r.valor,0)||1;
  const totalNecess=despesas.filter(d=>d.categoria==='necessidade').reduce((s,d)=>s+d.valor,0);
  const totalDesejos=despesas.filter(d=>d.categoria==='desejo').reduce((s,d)=>s+d.valor,0);
  const totalImprev=despesas.filter(d=>d.categoria==='imprevisto').reduce((s,d)=>s+d.valor,0);
  const unpaidBills=(bills||[]).filter(b=>!b.pago).reduce((s,b)=>s+b.valor,0);
  const totalDespesas=totalNecess+totalDesejos+totalImprev+unpaidBills;
  const poupanca= Math.max(totalReceitas-totalDespesas,0);
  const data=[totalNecess,totalDesejos,poupanca];
  const ctx=document.getElementById('expensePie');
  if(!pie){
    pie=new Chart(ctx,{type:'doughnut',data:{labels:['Necessidades','Desejos','Poupança'],datasets:[{data,backgroundColor:['#3B82F6','#EC4899','#10B981']}]},options:{plugins:{legend:{position:'bottom'}}}});
  }else{
    pie.data.datasets[0].data=data;
    pie.update();
  }
}

// -------- linha mensal ----------
let lineChart;
async function renderMonthlyLine(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data:rows,error}=await supabase.from('vw_resumo_mensal').select('*').eq('usuario_id',user.id).order('mes');
  if(error){console.error(error);return;}
  if(!rows||rows.length===0) return;
  const labels=rows.map(r=>new Date(r.mes).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}));
  const dataNec=rows.map(r=>r.total_necess);
  const dataDes=rows.map(r=>r.total_desejos);
  const dataPou=rows.map(r=>r.total_poupanca);
  const ctx=document.getElementById('lineMeses');
  if(!lineChart){
    lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:[
      {label:'Necessidades',data:dataNec,borderColor:'#3B82F6',backgroundColor:'rgba(59,130,246,0.2)',tension:.3},
      {label:'Desejos',data:dataDes,borderColor:'#EC4899',backgroundColor:'rgba(236,72,153,0.2)',tension:.3},
      {label:'Poupança',data:dataPou,borderColor:'#10B981',backgroundColor:'rgba(16,185,129,0.2)',tension:.3}
    ]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});
  }else{
    lineChart.data.labels=labels;
    lineChart.data.datasets[0].data=dataNec;
    lineChart.data.datasets[1].data=dataDes;
    lineChart.data.datasets[2].data=dataPou;
    lineChart.update();
  }
}

// ----- funções salário -----
salaryInput?.addEventListener('change', saveSalary);
async function saveSalary(){
  const val=parseFloat(salaryInput.value)||0;
  const {data:{user}}=await supabase.auth.getUser();
  await supabase.from('receitas').delete().eq('usuario_id',user.id).eq('descricao','Salário');
  if(val>0){
    await supabase.from('receitas').insert({usuario_id:user.id,descricao:'Salário',valor:val});
  }
  await renderIncomeList(); await updateDashboard();
}

// ------- ligar botões --------
document.getElementById('addIncomeBtn')?.addEventListener('click', addIncome);
document.getElementById('addFixedExpenseBtn')?.addEventListener('click', addFixedExpense);
document.getElementById('addVariableExpenseBtn')?.addEventListener('click', addVariableExpense);
document.getElementById('addUnexpectedExpenseBtn')?.addEventListener('click', addUnexpectedExpense);
document.getElementById('addBillBtn')?.addEventListener('click', addBill);

// Exportar para HTML
window.deleteIncome=deleteIncome;
window.deleteFixedExpense=deleteFixedExpense;
window.deleteVariableExpense=deleteVariableExpense;
window.deleteUnexpectedExpense=deleteUnexpectedExpense;
window.toggleBillStatus=toggleBillStatus;
window.deleteBill=deleteBill;

// -------- init --------
init();
async function init(){
  await loadSalary();
  await renderIncomeList();
  await renderFixedExpensesList();
  await renderVariableExpensesList();
  await renderUnexpectedExpensesList();
  await renderBillsTable();
  await updateDashboard();
  await updateChart();
  await renderMonthlyLine();
  await loadCategories();
}

async function loadSalary(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data, error}=await supabase.from('receitas').select('valor').eq('usuario_id',user.id).eq('descricao','Salário').single();
  if(!error && data){
    salaryInput.value = data.valor;
  }
}

// -------- categorias personalizadas --------
async function loadCategories(){
  const {data:{user}}=await supabase.auth.getUser();
  let {data:cats,error}=await supabase.from('categorias').select('*').eq('usuario_id',user.id).order('nome');
  if(error){console.error(error);return;}
  if(!cats||cats.length===0){
    const padrao=['Transporte','Alimentação','Lazer'];
    const inserts=padrao.map(n=>({usuario_id:user.id,nome:n,tipo:'desejo'}));
    const {error:e2}=await supabase.from('categorias').insert(inserts);
    if(e2) console.error(e2);
    ({data:cats}=await supabase.from('categorias').select('*').eq('usuario_id',user.id).order('nome'));
  }
  const sel=document.getElementById('variableCategory');
  sel.innerHTML=cats.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('')+`<option value="new">+ Nova</option>`;
}

document.getElementById('variableCategory')?.addEventListener('change',async e=>{
  if(e.target.value==='new'){
    const nome=prompt('Nome da nova categoria (desejo):');
    if(!nome) {loadCategories();return;}
    const {data:{user}}=await supabase.auth.getUser();
    const {data,error}=await supabase.from('categorias').insert({usuario_id:user.id,nome:nome,tipo:'desejo'}).select().single();
    if(error){alert(error.message);loadCategories();return;}
    await loadCategories();
    document.getElementById('variableCategory').value=data.id;
  }
});
        });
    </script>
</body>
</html>
