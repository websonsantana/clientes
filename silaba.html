<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syllable Snap Hunt</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2/dist/tesseract.min.js"></script>

<style>
    #cameraFeed {
        width: 100%;
        height: 420px;
        object-fit: cover;
        border-radius: 10px;
    }

    #highlightCanvas {
        position: absolute;
        inset: 0;
        pointer-events: none;
    }

    .highlight-text {
        background: yellow;
        padding: 2px;
        border-radius: 4px;
    }
</style>

</head>
<body class="bg-gray-100 min-h-screen">

<div class="container mx-auto px-4 py-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-indigo-700 mb-2">Syllable Snap Hunt</h1>
        <p class="text-gray-600">Encontre sílabas usando a câmera!</p>
    </header>

    <main class="max-w-md mx-auto bg-white rounded-xl shadow-md p-6">

        <!-- Input da sílaba -->
        <div class="mb-6">
            <label class="block mb-2 text-sm font-medium text-gray-700">Sílaba:</label>
            <div class="flex">
                <input id="syllable" type="text" class="flex-1 border-gray-300 rounded-l-md"
                       placeholder="Ex: ca, ma, ti">
                <button id="startBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-r-md">Procurar</button>
            </div>
        </div>

        <!-- Área da câmera -->
        <div id="cameraSection" class="hidden">
            <div class="relative rounded-lg overflow-hidden">
                <video id="cameraFeed" autoplay playsinline></video>
                <canvas id="highlightCanvas"></canvas>
            </div>

            <div class="flex justify-center gap-4 mt-4">
                <button id="captureBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Capturar</button>
                <button id="resetBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md">Reiniciar</button>
            </div>
        </div>

        <!-- Resultados -->
        <div id="resultsSection" class="hidden mt-6">
            <h3 class="font-medium mb-2">Resultado:</h3>
            <div id="results" class="bg-gray-50 p-4 rounded-md max-h-60 overflow-y-auto"></div>

            <h3 class="font-medium mt-4 mb-2">Imagem com Grifo:</h3>
            <canvas id="photoCanvas" class="w-full rounded-lg border"></canvas>
        </div>

    </main>
</div>

<script>
const startBtn = document.getElementById("startBtn");
const resetBtn = document.getElementById("resetBtn");
const captureBtn = document.getElementById("captureBtn");
const cameraSection = document.getElementById("cameraSection");
const resultsSection = document.getElementById("resultsSection");
const resultsDiv = document.getElementById("results");

const video = document.getElementById("cameraFeed");
const highlightCanvas = document.getElementById("highlightCanvas");
const photoCanvas = document.getElementById("photoCanvas");

let stream;

// Ligar câmera traseira
startBtn.onclick = async () => {
    const syl = document.getElementById("syllable").value.trim();
    if (!syl) return alert("Digite uma sílaba!");

    cameraSection.classList.remove("hidden");

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } }
        });
    } catch (e) {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }
        });
    }

    video.srcObject = stream;

    video.onloadedmetadata = () => {
        video.play();

        highlightCanvas.width = video.videoWidth;
        highlightCanvas.height = video.videoHeight;
    };
};

// Capturar imagem
captureBtn.onclick = async () => {
    if (video.videoWidth === 0) {
        return alert("A câmera ainda está carregando, aguarde 1 segundo...");
    }

    const syl = document.getElementById("syllable").value.trim().toLowerCase();
    if (!syl) return;

    photoCanvas.width = video.videoWidth;
    photoCanvas.height = video.videoHeight;

    const ctx = photoCanvas.getContext("2d");
    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);

    // OCR
    const { data: { text } } = await Tesseract.recognize(photoCanvas, "por");

    // Destacar sílaba no texto
    const highlightedText = text.replace(
        new RegExp(syl, "gi"),
        match => `<span class="highlight-text">${match}</span>`
    );

    resultsDiv.innerHTML = highlightedText;
    resultsSection.classList.remove("hidden");

    // Grifo simples na imagem
    ctx.fillStyle = "rgba(255,255,0,0.4)";
    const lines = text.split("\n");

    lines.forEach((line, i) => {
        if (line.toLowerCase().includes(syl)) {
            const y = (photoCanvas.height / lines.length) * i;
            const height = photoCanvas.height / lines.length;
            ctx.fillRect(0, y, photoCanvas.width, height);
        }
    });
};

// Reset
resetBtn.onclick = () => {
    window.location.reload();
};
</script>

</body>
</html>