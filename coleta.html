<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Fila de Retirada de Adubo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #2c3e50; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .admin { background: #ecf0f1; padding: 10px; margin-top: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fila de Retirada de Adubo</h1>

    <!-- Configuração Supabase -->
    <div id="config">
      <h3>Configuração Supabase</h3>
      <input type="text" id="url" placeholder="URL do Projeto" value="https://hudsoncity-hxbpb.supabase.co" />
      <input type="text" id="key" placeholder="Chave Pública (anon key)" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJscmFvZGR1Y2NsdG55aHlrYmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MDU3MzUsImV4cCI6MjA3MzM4MTczNX0.GHr4rRurb1zzy6g2lirATxghtmgt7PGjEPzA_vKlzY0" />
      <input type="password" id="adminPassword" placeholder="Senha de Administrador" />
      <button onclick="configurar()">Configurar</button>
    </div>

    <!-- Cadastro -->
    <div id="cadastro" class="hidden">
      <h3>Cadastro na Fila</h3>
      <input type="text" id="nome" placeholder="Nome" />
      <input type="email" id="email" placeholder="Email" />
      <input type="text" id="setor" placeholder="Setor" />
      <button onclick="cadastrar()">Entrar na Fila</button>
    </div>

    <!-- Painel Admin -->
    <div id="admin" class="hidden">
      <h3>Painel Administrativo</h3>
      <button onclick="listarFila()">Atualizar Fila</button>
      <table id="fila">
        <thead>
          <tr><th>Nome</th><th>Email</th><th>Setor</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    let supabase, senhaAdmin;

    function configurar() {
      const url = document.getElementById("url").value;
      const key = document.getElementById("key").value;
      senhaAdmin = document.getElementById("adminPassword").value;

      if (!url || !key || !senhaAdmin) {
        alert("Preencha todos os campos.");
        return;
      }

      supabase = supabase.createClient(url, key);
      document.getElementById("config").classList.add("hidden");
      document.getElementById("cadastro").classList.remove("hidden");
      document.getElementById("admin").classList.remove("hidden");
      listarFila();
    }

    async function cadastrar() {
      const name = document.getElementById("nome").value;
      const email = document.getElementById("email").value;
      const sector = document.getElementById("setor").value;

      if (!name || !email || !sector) {
        alert("Preencha todos os campos.");
        return;
      }

      const { error } = await supabase.from("fertilizer_queue").insert({
        name, email, sector, status: "waiting", joined_at: new Date().toISOString()
      });

      if (error) {
        alert("Erro ao cadastrar: " + error.message);
      } else {
        alert("Cadastro realizado com sucesso!");
        listarFila();
      }
    }

    async function listarFila() {
      const { data, error } = await supabase.from("fertilizer_queue").select("*").order("joined_at", { ascending: true });
      const tbody = document.querySelector("#fila tbody");
      tbody.innerHTML = "";

      if (error) {
        alert("Erro ao listar: " + error.message);
        return;
      }

      data.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>${item.email}</td>
          <td>${item.sector}</td>
          <td>${item.status}</td>
          <td>
            <button onclick="notificar('${item.id}')">Notificar</button>
            <button onclick="remover('${item.id}')">Remover</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function notificar(id) {
      await supabase.from("fertilizer_queue").update({ status: "ready" }).eq("id", id);
      alert("Usuário notificado!");
      listarFila();
    }

    async function remover(id) {
      await supabase.from("fertilizer_queue").delete().eq("id", id);
      alert("Usuário removido!");
      listarFila();
    }
  </script>
</body>
</html>
